[supervisord]
nodaemon=true
user=root
logfile=/dev/null

[program:dbus]
; 启动 DBus 系统服务
command=/usr/bin/dbus-daemon --system --nofork
autostart=true
autorestart=true
startsecs=1
priority=1
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

[program:xvfb]
; 启动虚拟 X 服务器，分配显示器 :99
command=/usr/bin/Xvfb :99 -screen 0 1280x1024x24
autostart=true
autorestart=true
startsecs=1
priority=1
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

[program:napcat]
; 关键：设置 $DISPLAY 环境变量并等待 DBus 和 Xvfb
environment=DISPLAY=":99"
command=/bin/bash /app/entrypoint.sh
directory=/app
autostart=true
autorestart=true
startsecs=5
depends_on=xvfb,dbus ; 确保在 NapCat 之前启动 Xvfb 和 DBus
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

[program:astrbot]
command=/usr/local/bin/python main.py
directory=/AstrBot
autostart=true
autorestart=true
startsecs=10
depends_on=napcat
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0