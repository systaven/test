import{u as X,r as m,z as N,ae as Y,o as s,k as c,b as a,w as t,D as R,E as $,d as i,t as o,h as n,H as U,l as f,e as M,Q as B,a8 as A,p as b,F as k,n as G,c as S,aY as q,U as J,aF as K,aG as Z,f as ee,W as ae,B as te,X as le,_ as I,aw as se,ax as oe}from"./index-427e6df5.js";import{C as re}from"./ConsoleDisplayer-b4e5ebdb.js";import{W as ie}from"./WaitingForRestart-c0cfd70f.js";import{_ as ne}from"./_plugin-vue_export-helper-c27b6911.js";const ce=V=>(se("data-v-0a09ebf0"),V=V(),oe(),V),de={class:"mb-4"},ue={key:0,class:"text-center py-8"},me={class:"mb-4"},fe={class:"mb-4"},pe={key:1,class:"migration-in-progress"},_e={class:"text-center py-4"},ge={class:"mb-4"},ve={class:"mb-4"},ye={class:"console-container"},he={key:2,class:"text-center py-8"},be={key:3,class:"text-center py-4"},ke={key:4},Ve={key:0,class:"text-center py-4"},xe={key:1},Ce=ce(()=>f("small",null,"请选择该平台类型下您主要使用的平台适配器。",-1)),we={__name:"MigrationDialog",setup(V,{expose:L}){const{t:l}=X(),g=m(!1),D=m(!1),p=m(""),_=m(!1),x=m(!1),C=m(null),w=m([]),v=m({}),P=m(null);let h=null;const E=N(()=>{const e={};return w.value.forEach(r=>{const d=r.platform_type||r.type;e[d]||(e[d]={type:d,platforms:[]}),e[d].platforms.push(r)}),Object.values(e)}),O=N(()=>E.value.every(e=>v.value[e.type]));Y(g,e=>{e?F():(w.value=[],v.value={},p.value="",_.value=!1,x.value=!1,C.value=null)});const F=async()=>{D.value=!0,p.value="";try{const e=await I.get("/api/config/platform/list");e.data.status==="ok"?(w.value=e.data.data.platforms||[],E.value.forEach(r=>{r.platforms.length>0&&(v.value[r.type]=r.platforms[0].id)})):p.value=e.data.message||l("features.migration.dialog.loadError")}catch(e){console.error("Failed to load platforms:",e),p.value=l("features.migration.dialog.loadError")}finally{D.value=!1}},T=async()=>{_.value=!0;try{const e={};Object.entries(v.value).forEach(([d,u])=>{w.value.find(Q=>Q.id===u)&&(e[d]={platform_id:u,platform_type:d})}),console.log("Migration platform_id_map:",e);const r=await I.post("/api/update/migration",{platform_id_map:e});if(r.data.status==="ok")x.value=!0,C.value={success:!0,message:r.data.message||l("features.migration.dialog.success")};else throw new Error(r.data.message||l("features.migration.dialog.migrationError"))}catch(e){console.error("Migration failed:",e),p.value=e.message||l("features.migration.dialog.migrationError")}finally{_.value=!1}},W=()=>{g.value=!1,h&&h({success:!1,cancelled:!0})},j=()=>{g.value=!1,h&&h(C.value)},z=e=>`${e.name||e.id||"Unknown"}`,H=()=>{I.post("/api/stat/restart-core").then(()=>{P.value&&P.value.check()})};return L({open:()=>(g.value=!0,new Promise(e=>{h=e}))}),(e,r)=>(s(),c(k,null,[a(le,{modelValue:g.value,"onUpdate:modelValue":r[0]||(r[0]=d=>g.value=d),persistent:"","max-width":"600","max-height":"80vh",scrollable:""},{default:t(()=>[a(R,null,{default:t(()=>[a($,null,{default:t(()=>[i(o(n(l)("features.migration.dialog.title")),1)]),_:1}),a(U,{class:"pa-6"},{default:t(()=>{var d;return[f("p",de,o(n(l)("features.migration.dialog.warning")),1),x.value?(s(),c("div",ue,[a(M,{size:"64",color:"success",class:"mb-4"},{default:t(()=>[i("mdi-check-circle")]),_:1}),f("h3",me,o(n(l)("features.migration.dialog.completed")),1),f("p",fe,o(((d=C.value)==null?void 0:d.message)||n(l)("features.migration.dialog.success")),1),a(B,{type:"info",variant:"tonal",class:"mb-4"},{prepend:t(()=>[a(M,null,{default:t(()=>[i("mdi-information")]),_:1})]),default:t(()=>[i(" "+o(n(l)("features.migration.dialog.restartRecommended")),1)]),_:1})])):_.value?(s(),c("div",pe,[f("div",_e,[a(A,{indeterminate:"",color:"primary",class:"mb-4"}),f("h3",ge,o(n(l)("features.migration.dialog.migrating")),1),f("p",ve,o(n(l)("features.migration.dialog.migratingSubtitle")),1)]),f("div",ye,[a(re,{ref:"consoleDisplayer",showLevelBtns:!1,style:{height:"300px"}},null,512)])])):D.value?(s(),c("div",he,[a(A,{indeterminate:"",color:"primary",class:"mb-4"}),f("p",null,o(n(l)("features.migration.dialog.loading")),1)])):p.value?(s(),c("div",be,[a(B,{type:"error",variant:"tonal",class:"mb-4"},{prepend:t(()=>[a(M,null,{default:t(()=>[i("mdi-alert")]),_:1})]),default:t(()=>[i(" "+o(p.value),1)]),_:1}),a(b,{color:"primary",onClick:F},{default:t(()=>[i(o(n(l)("features.migration.dialog.retry")),1)]),_:1})])):(s(),c("div",ke,[E.value.length===0?(s(),c("div",Ve,[a(B,{type:"info",variant:"tonal"},{prepend:t(()=>[a(M,null,{default:t(()=>[i("mdi-information")]),_:1})]),default:t(()=>[i(" "+o(n(l)("features.migration.dialog.noPlatforms")),1)]),_:1})])):(s(),c("div",xe,[(s(!0),c(k,null,G(E.value,u=>(s(),c("div",{key:u.type,class:"mb-6"},[u.platforms.length>1?(s(),S(R,{key:0,variant:"outlined"},{default:t(()=>[a(q,{class:"py-2"},{default:t(()=>[i(o(u.type),1)]),_:2},1024),a(J),a(U,{style:{padding:"16px"}},{default:t(()=>[Ce,(s(),S(K,{modelValue:v.value[u.type],"onUpdate:modelValue":y=>v.value[u.type]=y,key:u.type,"hide-details":""},{default:t(()=>[(s(!0),c(k,null,G(u.platforms,y=>(s(),S(Z,{key:y.id,value:y.id,label:z(y),color:"primary",class:"mb-1"},null,8,["value","label"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"]))]),_:2},1024)]),_:2},1024)):ee("",!0)]))),128))]))]))]}),_:1}),a(ae,{class:"px-6 py-4"},{default:t(()=>[a(te),x.value?(s(),c(k,{key:0},[a(b,{color:"grey",variant:"text",onClick:j},{default:t(()=>[i(o(n(l)("core.common.close")),1)]),_:1}),a(b,{color:"primary",variant:"elevated",onClick:H},{default:t(()=>[i(o(n(l)("features.migration.dialog.restartNow")),1)]),_:1})],64)):(s(),c(k,{key:1},[a(b,{color:"grey",variant:"text",onClick:W,disabled:_.value},{default:t(()=>[i(o(n(l)("core.common.cancel")),1)]),_:1},8,["disabled"]),a(b,{color:"primary",variant:"elevated",onClick:T,disabled:!O.value||_.value,loading:_.value},{default:t(()=>[i(o(n(l)("features.migration.dialog.startMigration")),1)]),_:1},8,["disabled","loading"])],64))]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(ie,{ref_key:"wfr",ref:P},null,512)],64))}},Se=ne(we,[["__scopeId","data-v-0a09ebf0"]]);export{Se as M};
