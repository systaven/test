import{u as C,a5 as T,o as r,k as a,l,F as g,n as _,A as b,v as w,t as p,f as u,d as v,b as f,w as S,c as B,ba as M,p as x,a8 as L}from"./index-427e6df5.js";import{M as E}from"./index-47e3efb7.js";import{H as y}from"./github-aa66a161.js";import{_ as H}from"./_plugin-vue_export-helper-c27b6911.js";const I=new E({html:!1,breaks:!0,linkify:!0,highlight:function(e,s){if(s&&y.getLanguage(s))try{return y.highlight(e,{language:s}).value}catch(t){console.error("Highlight error:",t)}return y.highlightAuto(e).value}}),N={name:"MessageList",props:{messages:{type:Array,required:!0},isDark:{type:Boolean,default:!1},isStreaming:{type:Boolean,default:!1}},emits:["openImagePreview"],setup(){const{t:e}=C(),{tm:s}=T("features/chat");return{t:e,tm:s,md:I}},data(){return{copiedMessages:new Set,isUserNearBottom:!0,scrollThreshold:1,scrollTimer:null}},mounted(){this.initCodeCopyButtons(),this.initImageClickEvents(),this.addScrollListener(),this.scrollToBottom()},updated(){this.initCodeCopyButtons(),this.initImageClickEvents(),this.isUserNearBottom&&this.scrollToBottom()},methods:{copyCodeToClipboard(e){navigator.clipboard.writeText(e).then(()=>{console.log("代码已复制到剪贴板")}).catch(s=>{console.error("复制失败:",s);const t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select();try{document.execCommand("copy"),console.log("代码已复制到剪贴板 (fallback)")}catch(o){console.error("复制失败 (fallback):",o)}document.body.removeChild(t)})},copyBotMessage(e,s){const t=this.messages[s].content;let o="";if(e&&e.trim()){const c=document.createElement("div");c.innerHTML=e,o=c.textContent||c.innerText||e}t&&t.embedded_images&&t.embedded_images.length>0&&(o&&(o+=`

`),o+=`[包含 ${t.embedded_images.length} 张图片]`),t&&t.embedded_audio&&(o&&(o+=`

`),o+="[包含音频内容]"),o.trim()||(o="[媒体内容]"),navigator.clipboard.writeText(o).then(()=>{console.log("消息已复制到剪贴板"),this.showCopySuccess(s)}).catch(c=>{console.error("复制失败:",c);const i=document.createElement("textarea");i.value=o,document.body.appendChild(i),i.select();try{document.execCommand("copy"),console.log("消息已复制到剪贴板 (fallback)"),this.showCopySuccess(s)}catch(n){console.error("复制失败 (fallback):",n)}document.body.removeChild(i)})},showCopySuccess(e){this.copiedMessages.add(e),setTimeout(()=>{this.copiedMessages.delete(e)},2e3)},getCopyIcon(e){return this.copiedMessages.has(e)?"mdi-check":"mdi-content-copy"},isCopySuccess(e){return this.copiedMessages.has(e)},getCopyIconSvg(){return'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>'},getSuccessIconSvg(){return'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20,6 9,17 4,12"></polyline></svg>'},initCodeCopyButtons(){this.$nextTick(()=>{var s;(((s=this.$refs.messageContainer)==null?void 0:s.querySelectorAll("pre code"))||[]).forEach((t,o)=>{const c=t.parentElement;if(c&&!c.querySelector(".copy-code-btn")){const i=document.createElement("button");i.className="copy-code-btn",i.innerHTML=this.getCopyIconSvg(),i.title="复制代码",i.addEventListener("click",()=>{this.copyCodeToClipboard(t.textContent),i.innerHTML=this.getSuccessIconSvg(),i.style.color="#4caf50",setTimeout(()=>{i.innerHTML=this.getCopyIconSvg(),i.style.color=""},2e3)}),c.style.position="relative",c.appendChild(i)}})})},initImageClickEvents(){this.$nextTick(()=>{document.querySelectorAll(".markdown-content img").forEach(s=>{s.hasAttribute("data-click-enabled")||(s.style.cursor="pointer",s.setAttribute("data-click-enabled","true"),s.onclick=()=>this.$emit("openImagePreview",s.src))})})},scrollToBottom(){this.$nextTick(()=>{const e=this.$refs.messageContainer;e&&(e.scrollTop=e.scrollHeight,this.isUserNearBottom=!0)})},addScrollListener(){const e=this.$refs.messageContainer;e&&e.addEventListener("scroll",this.throttledHandleScroll)},throttledHandleScroll(){this.scrollTimer||(this.scrollTimer=setTimeout(()=>{this.handleScroll(),this.scrollTimer=null},50))},handleScroll(){const e=this.$refs.messageContainer;if(e){const{scrollTop:s,scrollHeight:t,clientHeight:o}=e,c=t-(s+o);this.isUserNearBottom=c<=this.scrollThreshold}},beforeUnmount(){const e=this.$refs.messageContainer;e&&e.removeEventListener("scroll",this.throttledHandleScroll),this.scrollTimer&&(clearTimeout(this.scrollTimer),this.scrollTimer=null)}}},A={class:"messages-container",ref:"messageContainer"},V={class:"message-list"},$={key:0,class:"user-message"},z={style:{"font-family":"inherit","white-space":"pre-wrap","word-wrap":"break-word"}},P={key:0,class:"image-attachments"},U=["src","onClick"],q={key:1,class:"audio-attachment"},D={controls:"",class:"audio-player"},F=["src"],j={key:1,class:"bot-message"},J={key:1,class:"text-h2"},O={class:"bot-message-content"},G={class:"message-bubble bot-bubble"},K=["innerHTML"],Q={key:1,class:"embedded-images"},R=["src","onClick"],W={key:2,class:"embedded-audio"},X={controls:"",class:"audio-player"},Y=["src"],Z={class:"message-actions"};function ee(e,s,t,o,c,i){return r(),a("div",A,[l("div",V,[(r(!0),a(g,null,_(t.messages,(n,h)=>(r(),a("div",{class:"message-item fade-in",key:h},[n.content.type=="user"?(r(),a("div",$,[l("div",{class:b(["message-bubble user-bubble",{"has-audio":n.content.audio_url}]),style:w({backgroundColor:t.isDark?"#2d2e30":"#e7ebf4"})},[l("pre",z,p(n.content.message),1),n.content.image_url&&n.content.image_url.length>0?(r(),a("div",P,[(r(!0),a(g,null,_(n.content.image_url,(d,m)=>(r(),a("div",{key:m,class:"image-attachment"},[l("img",{src:d,class:"attached-image",onClick:k=>e.$emit("openImagePreview",d)},null,8,U)]))),128))])):u("",!0),n.content.audio_url&&n.content.audio_url.length>0?(r(),a("div",q,[l("audio",D,[l("source",{src:n.content.audio_url,type:"audio/wav"},null,8,F),v(" "+p(o.t("messages.errors.browser.audioNotSupported")),1)])])):u("",!0)],6)])):(r(),a("div",j,[f(M,{class:"bot-avatar",size:"36"},{default:S(()=>{var d;return[t.isStreaming&&h===t.messages.length-1?(r(),B(L,{key:0,index:h,indeterminate:"",size:"28",width:"2"},null,8,["index"])):((d=t.messages[h-1])==null?void 0:d.content.type)!=="bot"?(r(),a("span",J,"✨")):u("",!0)]}),_:2},1024),l("div",O,[l("div",G,[n.content.message&&n.content.message.trim()?(r(),a("div",{key:0,innerHTML:o.md.render(n.content.message),class:"markdown-content"},null,8,K)):u("",!0),n.content.embedded_images&&n.content.embedded_images.length>0?(r(),a("div",Q,[(r(!0),a(g,null,_(n.content.embedded_images,(d,m)=>(r(),a("div",{key:m,class:"embedded-image"},[l("img",{src:d,class:"bot-embedded-image",onClick:k=>e.$emit("openImagePreview",d)},null,8,R)]))),128))])):u("",!0),n.content.embedded_audio?(r(),a("div",W,[l("audio",X,[l("source",{src:n.content.embedded_audio,type:"audio/wav"},null,8,Y),v(" "+p(o.t("messages.errors.browser.audioNotSupported")),1)])])):u("",!0)]),l("div",Z,[f(x,{icon:i.getCopyIcon(h),size:"small",variant:"text",class:b(["copy-message-btn",{"copy-success":i.isCopySuccess(h)}]),onClick:d=>i.copyBotMessage(n.content.message,h),title:o.t("core.common.copy")},null,8,["icon","class","onClick","title"])])])]))]))),128))])],512)}const ie=H(N,[["render",ee],["__scopeId","data-v-2181163b"]]);export{ie as M};
