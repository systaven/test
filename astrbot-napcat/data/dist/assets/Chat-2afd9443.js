import{_,o as c,k as v,c as g,w as l,d as C,t as m,p as f,b as r,D as I,E as H,H as D,l as n,m as K,F as T,n as U,j as O,g as B,i as j,f as u,e as b,T as Y,W as Z,B as $,X as W,aw as se,ax as ie,b7 as oe,u as ae,a5 as re,b8 as le,r as ne,a6 as A,A as G,v as de,U as X,a as ce,x as q,ai as he,S as P,C as F,J as ue,b9 as me,a8 as ge,V as pe,aJ as ve}from"./index-427e6df5.js";import{u as Q}from"./customizer-fda73318.js";import{L as fe,_ as Ce}from"./LanguageSwitcher-d6ec75cb.js";import{_ as ee}from"./_plugin-vue_export-helper-c27b6911.js";import{M as _e}from"./MessageList-54c4e872.js";import"./github-aa66a161.js";const ye={name:"ProviderModelSelector",props:{initialProvider:{type:String,default:""},initialModel:{type:String,default:""}},emits:["selection-changed"],data(){return{showDialog:!1,providerConfigs:[],modelList:[],selectedProviderId:"",selectedModelName:"",tempSelectedProviderId:"",tempSelectedModelName:"",loadingModels:!1}},mounted(){this.loadFromStorage(),this.resetTempSelection(),this.loadProviderConfigs(),this.selectedProviderId&&this.getProviderModels(this.selectedProviderId)},methods:{loadFromStorage(){const s=localStorage.getItem("selectedProvider"),e=localStorage.getItem("selectedModel");s?this.selectedProviderId=s:this.initialProvider&&(this.selectedProviderId=this.initialProvider),e?this.selectedModelName=e:this.initialModel&&(this.selectedModelName=this.initialModel)},saveToStorage(){this.selectedProviderId&&localStorage.setItem("selectedProvider",this.selectedProviderId),this.selectedModelName&&localStorage.setItem("selectedModel",this.selectedModelName)},loadProviderConfigs(){_.get("/api/config/provider/list",{params:{provider_type:"chat_completion"}}).then(s=>{s.data.status==="ok"?this.providerConfigs=s.data.data||[]:console.error("获取聊天完成提供商列表失败:",s.data.message)}).catch(s=>{console.error("获取聊天完成提供商列表失败:",s)})},getProviderModels(s){this.loadingModels=!0,_.get("/api/config/provider/model_list",{params:{provider_id:s}}).then(e=>{e.data.status==="ok"?this.modelList=e.data.data.models||[]:(console.error("获取模型列表失败:",e.data.message),this.modelList=[])}).catch(e=>{console.error("获取模型列表失败:",e),this.modelList=[]}).finally(()=>{this.loadingModels=!1})},selectProvider(s){this.tempSelectedProviderId=s.id,this.tempSelectedModelName="",this.modelList=[],this.getProviderModels(s.id)},selectModel(s){this.tempSelectedModelName=s},refreshModels(){this.tempSelectedProviderId&&this.getProviderModels(this.tempSelectedProviderId)},confirmSelection(){this.tempSelectedProviderId&&this.tempSelectedModelName&&(this.selectedProviderId=this.tempSelectedProviderId,this.selectedModelName=this.tempSelectedModelName,this.saveToStorage(),this.$emit("selection-changed",{providerId:this.selectedProviderId,modelName:this.selectedModelName}),this.closeDialog())},closeDialog(){this.showDialog=!1,this.resetTempSelection()},resetTempSelection(){this.tempSelectedProviderId=this.selectedProviderId,this.tempSelectedModelName=this.selectedModelName,this.tempSelectedProviderId&&this.getProviderModels(this.tempSelectedProviderId)},openDialog(){this.resetTempSelection(),this.showDialog=!0},getCurrentSelection(){return{providerId:this.selectedProviderId,modelName:this.selectedModelName}}}},S=s=>(se("data-v-54c2d662"),s=s(),ie(),s),be=S(()=>n("span",null,"选择提供商和模型",-1)),ke={class:"provider-model-container"},xe={class:"provider-list-panel"},we=S(()=>n("div",{class:"panel-header"},[n("h4",null,"提供商")],-1)),Me={key:0,class:"empty-state"},Se=S(()=>n("div",{class:"empty-text"},"暂无可用提供商",-1)),Ie={class:"model-list-panel"},Te={class:"panel-header"},Pe=S(()=>n("h4",null,"模型",-1)),De={key:1,class:"empty-state"},Ue=S(()=>n("div",{class:"empty-text"},"请先选择提供商",-1)),Re={key:2,class:"empty-state"},Le=S(()=>n("div",{class:"empty-text"},"该提供商暂无可用模型",-1));function Ne(s,e,i,o,t,a){return c(),v("div",null,[t.selectedProviderId&&t.selectedModelName?(c(),g(f,{key:0,class:"text-none",variant:"tonal",rounded:"xl",size:"small",onClick:a.openDialog},{default:l(()=>[C(m(t.selectedProviderId)+" / "+m(t.selectedModelName),1)]),_:1},8,["onClick"])):(c(),g(f,{key:1,variant:"tonal",rounded:"xl",size:"small",onClick:a.openDialog},{default:l(()=>[C(" 选择模型 ")]),_:1},8,["onClick"])),r(W,{modelValue:t.showDialog,"onUpdate:modelValue":e[1]||(e[1]=h=>t.showDialog=h),"max-width":"800",persistent:""},{default:l(()=>[r(I,{style:{padding:"8px"}},{default:l(()=>[r(H,{class:"dialog-title"},{default:l(()=>[be]),_:1}),r(D,{class:"pa-0"},{default:l(()=>[n("div",ke,[n("div",xe,[we,r(K,{density:"compact",nav:"",class:"provider-list"},{default:l(()=>[(c(!0),v(T,null,U(t.providerConfigs,h=>(c(),g(O,{key:h.id,value:h.id,onClick:w=>a.selectProvider(h),active:t.tempSelectedProviderId===h.id,rounded:"lg",class:"provider-item"},{default:l(()=>[r(B,null,{default:l(()=>[C(m(h.id),1)]),_:2},1024),h.api_base?(c(),g(j,{key:0},{default:l(()=>[C(m(h.api_base),1)]),_:2},1024)):u("",!0)]),_:2},1032,["value","onClick","active"]))),128))]),_:1}),t.providerConfigs.length===0?(c(),v("div",Me,[r(b,{icon:"mdi-cloud-off-outline",size:"large",color:"grey-lighten-1"}),Se])):u("",!0)]),n("div",Ie,[n("div",Te,[Pe,t.tempSelectedProviderId?(c(),g(f,{key:0,icon:"mdi-refresh",size:"small",variant:"text",onClick:a.refreshModels,loading:t.loadingModels},null,8,["onClick","loading"])):u("",!0)]),t.tempSelectedProviderId?(c(),g(K,{key:0,density:"compact",nav:"",class:"model-list"},{default:l(()=>[r(Y,{modelValue:t.tempSelectedModelName,"onUpdate:modelValue":e[0]||(e[0]=h=>t.tempSelectedModelName=h),placeholder:"自定义模型","hide-details":"",solo:"",variant:"outlined",density:"compact",class:"mb-2 mx-2"},null,8,["modelValue"]),(c(!0),v(T,null,U(t.modelList,h=>(c(),g(O,{key:h,value:h,onClick:w=>a.selectModel(h),active:t.tempSelectedModelName===h,rounded:"lg",class:"model-item"},{default:l(()=>[r(B,null,{default:l(()=>[C(m(h),1)]),_:2},1024),h.description?(c(),g(j,{key:0},{default:l(()=>[C(m(h.description),1)]),_:2},1024)):u("",!0)]),_:2},1032,["value","onClick","active"]))),128))]),_:1})):(c(),v("div",De,[r(b,{icon:"mdi-robot-outline",size:"large",color:"grey-lighten-1"}),Ue])),t.tempSelectedProviderId&&t.modelList.length===0&&!t.loadingModels?(c(),v("div",Re,[r(b,{icon:"mdi-robot-off-outline",size:"large",color:"grey-lighten-1"}),Le])):u("",!0)])])]),_:1}),r(Z,null,{default:l(()=>[r($),r(f,{text:"",onClick:a.closeDialog,color:"grey-darken-1"},{default:l(()=>[C("取消")]),_:1},8,["onClick"]),r(f,{text:"",onClick:a.confirmSelection,color:"primary",disabled:!t.tempSelectedProviderId||!t.tempSelectedModelName},{default:l(()=>[C(" 确认选择 ")]),_:1},8,["onClick","disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}const Ee=ee(ye,[["render",Ne],["__scopeId","data-v-54c2d662"]]);function Ve(){const s=oe(),e=(i,o="info",t={})=>s.add({message:i,color:o,...t});return{toast:e,success:(i,o)=>e(i,"success",o),error:(i,o)=>e(i,"error",o),info:(i,o)=>e(i,"primary",o),warning:(i,o)=>e(i,"warning",o)}}const ze={name:"ChatPage",components:{LanguageSwitcher:fe,ProviderModelSelector:Ee,MessageList:_e},props:{chatboxMode:{type:Boolean,default:!1}},setup(){const{t:s}=ae(),{tm:e}=re("features/chat");return{t:s,tm:e,router:le,ref:ne}},data(){return{prompt:"",messages:[],conversations:[],selectedConversations:[],currCid:"",stagedImagesName:[],stagedImagesUrl:[],loadingChat:!1,inputFieldLabel:"",isRecording:!1,audioChunks:[],stagedAudioUrl:"",mediaRecorder:null,ctrlKeyDown:!1,ctrlKeyTimer:null,ctrlKeyLongPressThreshold:300,mediaCache:{},editTitleDialog:!1,editingTitle:"",editingCid:"",sidebarCollapsed:!0,sidebarHovered:!1,sidebarHoverTimer:null,sidebarHoverExpanded:!1,sidebarHoverDelay:100,pendingCid:null,imagePreviewDialog:!1,previewImageUrl:"",isStreaming:!1,isConvRunning:!1,isToastedRunningInfo:!1}},computed:{isDark(){return Q().uiTheme==="PurpleThemeDark"},getCurrentConversation(){return this.currCid?this.conversations.find(s=>s.cid===this.currCid):null}},watch:{$route:{immediate:!0,handler(s,e){if(console.log("Route changed:",s.path,"from:",e==null?void 0:e.path),e&&(e.path.startsWith("/chat")&&s.path.startsWith("/chatbox")||e.path.startsWith("/chatbox")&&s.path.startsWith("/chat")),s.path.startsWith("/chat/")||s.path.startsWith("/chatbox/")){const i=s.path.split("/")[2];console.log("Path CID:",i),i&&i!==this.currCid&&(this.conversations.length>0?this.conversations.find(t=>t.cid===i)&&this.getConversationMessages([i]):this.pendingCid=i)}}},conversations:{handler(s){if(this.pendingCid&&s.length>0)s.find(i=>i.cid===this.pendingCid)&&(this.selectedConversations=[this.pendingCid],this.getConversationMessages([this.pendingCid]),this.pendingCid=null);else if(!this.currCid&&s.length>0){const e=s[0];this.selectedConversations=[e.cid],this.getConversationMessages([e.cid])}}}},mounted(){const s=localStorage.getItem("sidebarCollapsed");s!==null?this.sidebarCollapsed=JSON.parse(s):this.sidebarCollapsed=!0,this.inputFieldLabel=this.tm("input.chatPrompt"),this.getConversations();let e=document.getElementById("input-field");e.addEventListener("paste",this.handlePaste),e.addEventListener("keydown",(function(i){i.keyCode==13&&!i.shiftKey&&(i.preventDefault(),this.canSendMessage()&&this.sendMessage())}).bind(this)),document.addEventListener("keyup",this.handleInputKeyUp)},beforeUnmount(){document.removeEventListener("keyup",this.handleInputKeyUp),this.sidebarHoverTimer&&clearTimeout(this.sidebarHoverTimer),this.cleanupMediaCache()},methods:{toggleTheme(){const s=Q(),e=s.uiTheme==="PurpleTheme"?"PurpleThemeDark":"PurpleTheme";s.SET_UI_THEME(e)},toggleSidebar(){if(this.sidebarHoverExpanded){this.sidebarHoverExpanded=!1;return}this.sidebarCollapsed=!this.sidebarCollapsed,localStorage.setItem("sidebarCollapsed",JSON.stringify(this.sidebarCollapsed))},handleSidebarMouseEnter(){this.sidebarCollapsed&&(this.sidebarHovered=!0,this.sidebarHoverTimer=setTimeout(()=>{this.sidebarHovered&&(this.sidebarHoverExpanded=!0,this.sidebarCollapsed=!1)},this.sidebarHoverDelay))},handleSidebarMouseLeave(){this.sidebarHovered=!1,this.sidebarHoverTimer&&(clearTimeout(this.sidebarHoverTimer),this.sidebarHoverTimer=null),this.sidebarHoverExpanded&&(this.sidebarCollapsed=!0),this.sidebarHoverExpanded=!1},showEditTitleDialog(s,e){this.editingCid=s,this.editingTitle=e||"",this.editTitleDialog=!0},saveTitle(){if(!this.editingCid)return;const s=this.editingTitle.trim();_.post("/api/chat/rename_conversation",{conversation_id:this.editingCid,title:s}).then(e=>{const i=this.conversations.find(o=>o.cid===this.editingCid);i&&(i.title=s),this.editTitleDialog=!1}).catch(e=>{console.error("重命名对话失败:",e)})},async getMediaFile(s){if(this.mediaCache[s])return this.mediaCache[s];try{const e=await _.get("/api/chat/get_file",{params:{filename:s},responseType:"blob"}),i=URL.createObjectURL(e.data);return this.mediaCache[s]=i,i}catch(e){return console.error("Error fetching media file:",e),""}},removeAudio(){this.stagedAudioUrl=null},openImagePreview(s){this.previewImageUrl=s,this.imagePreviewDialog=!0},async startRecording(){const s=await navigator.mediaDevices.getUserMedia({audio:!0});this.mediaRecorder=new MediaRecorder(s),this.mediaRecorder.ondataavailable=e=>{this.audioChunks.push(e.data)},this.mediaRecorder.start(),this.isRecording=!0,this.inputFieldLabel=this.tm("input.recordingPrompt")},async stopRecording(){this.isRecording=!1,this.inputFieldLabel=this.tm("input.chatPrompt"),this.mediaRecorder.stop(),this.mediaRecorder.onstop=async()=>{const s=new Blob(this.audioChunks,{type:"audio/wav"});this.audioChunks=[],this.mediaRecorder.stream.getTracks().forEach(i=>i.stop());const e=new FormData;e.append("file",s);try{const o=(await _.post("/api/chat/post_file",e,{headers:{"Content-Type":"multipart/form-data"}})).data.data.filename;console.log("Audio uploaded:",o),this.stagedAudioUrl=o}catch(i){console.error("Error uploading audio:",i)}}},async processAndUploadImage(s){const e=new FormData;e.append("file",s);try{const o=(await _.post("/api/chat/post_image",e,{headers:{"Content-Type":"multipart/form-data"}})).data.data.filename;this.stagedImagesName.push(o),this.stagedImagesUrl.push(URL.createObjectURL(s))}catch(i){console.error("Error uploading image:",i)}},async handlePaste(s){console.log("Pasting image...");const e=s.clipboardData.items;for(let i=0;i<e.length;i++)if(e[i].type.indexOf("image")!==-1){const o=e[i].getAsFile();this.processAndUploadImage(o)}},removeImage(s){const e=this.stagedImagesUrl[s];e&&e.startsWith("blob:")&&URL.revokeObjectURL(e),this.stagedImagesName.splice(s,1),this.stagedImagesUrl.splice(s,1)},clearMessage(){this.prompt=""},triggerImageInput(){this.$refs.imageInput.click()},handleFileSelect(s){const e=s.target.files;if(e)for(const i of e)this.processAndUploadImage(i);s.target.value=""},getConversations(){_.get("/api/chat/conversations").then(s=>{if(this.conversations=s.data.data,this.pendingCid)this.conversations.find(i=>i.cid===this.pendingCid)&&(this.getConversationMessages([this.pendingCid]),this.pendingCid=null);else if(!this.currCid&&this.conversations.length>0){const e=this.conversations[0];this.selectedConversations=[e.cid],this.getConversationMessages([e.cid])}}).catch(s=>{s.response.status===401&&this.$router.push("/auth/login?redirect=/chatbox"),console.error(s)})},getConversationMessages(s){if(s[0]){if(this.$route.path!==`/chat/${s[0]}`&&this.$route.path!==`/chatbox/${s[0]}`){this.$route.path.startsWith("/chatbox")?this.$router.push(`/chatbox/${s[0]}`):this.$router.push(`/chat/${s[0]}`);return}_.get("/api/chat/get_conversation?conversation_id="+s[0]).then(async e=>{this.currCid=s[0],this.selectedConversations=[s[0]];let i=e.data.data.history;this.isConvRunning=e.data.data.is_running||!1,this.isConvRunning&&(this.isToastedRunningInfo||(Ve().info("该对话正在运行中。",{timeout:5e3}),this.isToastedRunningInfo=!0),setTimeout(()=>{this.getConversationMessages([this.currCid])},3e3)),this.$nextTick(()=>{this.$refs.messageList.scrollToBottom()});for(let o=0;o<i.length;o++){let t=i[o].content;if(t.message.startsWith("[IMAGE]")){let a=t.message.replace("[IMAGE]","");const h=await this.getMediaFile(a);t.embedded_images||(t.embedded_images=[]),t.embedded_images.push(h),t.message=""}if(t.message.startsWith("[RECORD]")){let a=t.message.replace("[RECORD]","");const h=await this.getMediaFile(a);t.embedded_audio=h,t.message=""}if(t.image_url&&t.image_url.length>0)for(let a=0;a<t.image_url.length;a++)t.image_url[a]=await this.getMediaFile(t.image_url[a]);t.audio_url&&(t.audio_url=await this.getMediaFile(t.audio_url))}this.messages=i}).catch(e=>{console.error(e)})}},async newConversation(){return _.get("/api/chat/new_conversation").then(s=>{const e=s.data.data.conversation_id;return this.currCid=e,this.$route.path.startsWith("/chatbox")?this.$router.push(`/chatbox/${e}`):this.$router.push(`/chat/${e}`),this.getConversations(),e}).catch(s=>{throw console.error(s),s})},newC(){this.currCid="",this.selectedConversations=[],this.messages=[],this.$route.path.startsWith("/chatbox")?this.$router.push("/chatbox"):this.$router.push("/chat")},formatDate(s){const e=new Date(s*1e3),i={year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1},o=this.t("core.common.locale")||"zh-CN";return e.toLocaleString(o,i).replace(/\//g,"-").replace(/, /g," ")},deleteConversation(s){_.get("/api/chat/delete_conversation?conversation_id="+s).then(e=>{this.getConversations(),this.currCid="",this.selectedConversations=[],this.messages=[]}).catch(e=>{console.error(e)})},canSendMessage(){return this.prompt&&this.prompt.trim()||this.stagedImagesName.length>0||this.stagedAudioUrl},async sendMessage(){var w;if(!this.canSendMessage()){console.log("没有内容可发送");return}this.currCid==""&&await this.newConversation();const s=this.prompt.trim(),e=[...this.stagedImagesName],i=this.stagedAudioUrl;this.prompt="",this.stagedImagesName=[],this.stagedImagesUrl=[],this.stagedAudioUrl="";const o={type:"user",message:s,image_url:[],audio_url:null};if(e.length>0){const y=e.map(d=>d.startsWith("blob:")?Promise.resolve(d):this.getMediaFile(d));o.image_url=await Promise.all(y)}i&&(i.startsWith("blob:")?o.audio_url=i:o.audio_url=await this.getMediaFile(i)),this.messages.push({content:o}),this.loadingChat=!0;const t=(w=this.$refs.providerModelSelector)==null?void 0:w.getCurrentSelection(),a=(t==null?void 0:t.providerId)||"",h=(t==null?void 0:t.modelName)||"";try{const y=await fetch("/api/chat/send",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")},body:JSON.stringify({message:s,conversation_id:this.currCid,image_url:e,audio_url:i?[i]:[],selected_provider:a,selected_model:h})});if(!y.ok)throw new Error(`HTTP error! status: ${y.status}`);const d=y.body.getReader(),x=new TextDecoder;let M=!1,R=null;for(this.isStreaming=!0;;)try{const{done:L,value:te}=await d.read();if(L){console.log("SSE stream completed");break}const J=x.decode(te,{stream:!0}).split(`

`);for(let N=0;N<J.length;N++){let E=J[N].trim();if(!E)continue;let p;try{p=JSON.parse(E.replace("data: ",""))}catch(k){console.warn("JSON解析失败:",E,k);continue}if(!p||typeof p!="object"||!p.hasOwnProperty("type")){console.warn("无效的数据对象:",p);continue}if(p.type==="error"){console.error("Error received:",p.data);continue}if(p.type==="image"){let k=p.data.replace("[IMAGE]",""),z={type:"bot",message:"",embedded_images:[await this.getMediaFile(k)]};this.messages.push({content:z})}else if(p.type==="record"){let k=p.data.replace("[RECORD]",""),z={type:"bot",message:"",embedded_audio:await this.getMediaFile(k)};this.messages.push({content:z})}else if(p.type==="plain")M?R.message.value+=p.data:(R={type:"bot",message:this.ref(p.data)},this.messages.push({content:R}),M=!0);else if(p.type==="update_title"){const k=this.conversations.find(V=>V.cid===p.cid);k&&(k.title=p.data)}(p.type==="break"&&p.streaming||!p.streaming)&&(M=!1)}}catch(L){console.error("SSE读取错误:",L);break}this.loadingChat=!1,this.getConversations()}catch(y){console.error("发送消息失败:",y),this.loadingChat=!1}finally{this.isStreaming=!1}},handleInputKeyDown(s){if(s.ctrlKey&&s.keyCode===66){if(s.preventDefault(),this.ctrlKeyDown)return;this.ctrlKeyDown=!0,this.ctrlKeyTimer=setTimeout(()=>{this.ctrlKeyDown&&!this.isRecording&&this.startRecording()},this.ctrlKeyLongPressThreshold)}},handleInputKeyUp(s){s.keyCode===66&&(this.ctrlKeyDown=!1,this.ctrlKeyTimer&&(clearTimeout(this.ctrlKeyTimer),this.ctrlKeyTimer=null),this.isRecording&&this.stopRecording())},cleanupMediaCache(){Object.values(this.mediaCache).forEach(s=>{s.startsWith("blob:")&&URL.revokeObjectURL(s)}),this.mediaCache={}}}},Ae={class:"chat-layout"},Fe={key:0,style:{display:"flex","align-items":"center","justify-content":"center",padding:"16px","padding-bottom":"0px"}},He=n("img",{width:"50",src:Ce,alt:"AstrBot Logo"},null,-1),Ke={key:0,style:{"font-weight":"1000","font-size":"26px","margin-left":"8px"}},Oe={class:"sidebar-collapse-btn-container"},Be={style:{padding:"16px","padding-top":"8px"}},je={key:1},We={class:"conversation-actions"},Je={key:0,class:"no-conversations"},Ge={key:0,class:"no-conversations-text"},Xe={class:"chat-content-panel"},qe={class:"conversation-header fade-in"},Qe={key:0},Ye={style:{"max-width":"300px",overflow:"hidden","text-overflow":"ellipsis","white-space":"nowrap"}},Ze={style:{"font-size":"12px"}},$e={class:"conversation-header-actions"},et={key:2,class:"welcome-container fade-in"},tt=n("div",{class:"welcome-title"},[n("span",null,"Hello, I'm"),n("span",{class:"bot-name"},"AstrBot ⭐")],-1),st={class:"welcome-hint markdown-content"},it=n("code",null,"help",-1),ot={class:"welcome-hint markdown-content"},at=n("code",null,"Ctrl + B",-1),rt={class:"welcome-hint markdown-content"},lt=n("code",null,"Ctrl + V",-1),nt={class:"input-area fade-in"},dt={style:{width:"85%","max-width":"900px",margin:"0 auto",border:"1px solid #e0e0e0","border-radius":"24px"}},ct=["disabled"],ht={style:{display:"flex","justify-content":"space-between","align-items":"center",padding:"0px 8px"}},ut={style:{display:"flex","justify-content":"flex-start","margin-top":"4px"}},mt={style:{display:"flex","justify-content":"flex-end","margin-top":"8px","align-items":"center"}},gt={key:0,class:"attachments-preview"},pt=["src"],vt={key:0,class:"audio-preview"},ft=["src"];function Ct(s,e,i,o,t,a){const h=A("LanguageSwitcher"),w=A("MessageList"),y=A("ProviderModelSelector");return c(),v(T,null,[r(I,{class:"chat-page-card"},{default:l(()=>[r(D,{class:"chat-page-container"},{default:l(()=>[n("div",Ae,[n("div",{class:G(["sidebar-panel",{"sidebar-collapsed":t.sidebarCollapsed}]),style:de({"background-color":a.isDark?t.sidebarCollapsed?"#1e1e1e":"#2d2d2d":t.sidebarCollapsed?"#ffffff":"#f5f5f5"}),onMouseenter:e[1]||(e[1]=(...d)=>a.handleSidebarMouseEnter&&a.handleSidebarMouseEnter(...d)),onMouseleave:e[2]||(e[2]=(...d)=>a.handleSidebarMouseLeave&&a.handleSidebarMouseLeave(...d))},[i.chatboxMode?(c(),v("div",Fe,[He,t.sidebarCollapsed?u("",!0):(c(),v("span",Ke,"AstrBot"))])):u("",!0),n("div",Oe,[r(f,{icon:"",class:"sidebar-collapse-btn",onClick:a.toggleSidebar,variant:"text",color:"deep-purple"},{default:l(()=>[r(b,null,{default:l(()=>[C(m(t.sidebarCollapsed||!t.sidebarCollapsed&&t.sidebarHoverExpanded?"mdi-chevron-right":"mdi-chevron-left"),1)]),_:1})]),_:1},8,["onClick"])]),n("div",Be,[t.sidebarCollapsed?u("",!0):(c(),g(f,{key:0,block:"",variant:"text",class:"new-chat-btn",onClick:a.newC,disabled:!t.currCid,"prepend-icon":"mdi-plus",style:{"background-color":"transparent !important","border-radius":"4px"}},{default:l(()=>[C(m(o.tm("actions.newChat")),1)]),_:1},8,["onClick","disabled"])),t.sidebarCollapsed?(c(),g(f,{key:1,icon:"mdi-plus",rounded:"lg",onClick:a.newC,disabled:!t.currCid,elevation:"0"},null,8,["onClick","disabled"])):u("",!0)]),t.sidebarCollapsed?u("",!0):(c(),v("div",je,[r(X,{class:"mx-4"})])),t.sidebarCollapsed?u("",!0):(c(),v("div",{key:2,style:{"overflow-y":"auto","flex-grow":"1"},class:G({"fade-in":t.sidebarHoverExpanded})},[t.conversations.length>0?(c(),g(I,{key:0,flat:"",style:{"background-color":"transparent"}},{default:l(()=>[r(K,{density:"compact",nav:"",class:"conversation-list",style:{"background-color":"transparent"},selected:t.selectedConversations,"onUpdate:selected":[e[0]||(e[0]=d=>t.selectedConversations=d),a.getConversationMessages]},{default:l(()=>[(c(!0),v(T,null,U(t.conversations,(d,x)=>(c(),g(O,{key:d.cid,value:d.cid,rounded:"lg",class:"conversation-item","active-color":"secondary"},ce({default:l(()=>[t.sidebarCollapsed?u("",!0):(c(),g(B,{key:0,class:"conversation-title"},{default:l(()=>[C(m(d.title||o.tm("conversation.newConversation")),1)]),_:2},1024)),t.sidebarCollapsed?u("",!0):(c(),g(j,{key:1,class:"timestamp"},{default:l(()=>[C(m(a.formatDate(d.updated_at)),1)]),_:2},1024))]),_:2},[t.sidebarCollapsed?void 0:{name:"append",fn:l(()=>[n("div",We,[r(f,{icon:"mdi-pencil",size:"x-small",variant:"text",class:"edit-title-btn",onClick:q(M=>a.showEditTitleDialog(d.cid,d.title),["stop"])},null,8,["onClick"]),r(f,{icon:"mdi-delete",size:"x-small",variant:"text",class:"delete-conversation-btn",color:"error",onClick:q(M=>a.deleteConversation(d.cid),["stop"])},null,8,["onClick"])])]),key:"0"}]),1032,["value"]))),128))]),_:1},8,["selected","onUpdate:selected"])]),_:1})):u("",!0),r(he,null,{default:l(()=>[t.conversations.length===0?(c(),v("div",Je,[r(b,{icon:"mdi-message-text-outline",size:"large",color:"grey-lighten-1"}),!t.sidebarCollapsed||t.sidebarHoverExpanded?(c(),v("div",Ge,m(o.tm("conversation.noHistory")),1)):u("",!0)])):u("",!0)]),_:1})],2))],38),n("div",Xe,[n("div",qe,[t.currCid&&a.getCurrentConversation?(c(),v("div",Qe,[n("h3",Ye,m(a.getCurrentConversation.title||o.tm("conversation.newConversation")),1),n("span",Ze,m(a.formatDate(a.getCurrentConversation.updated_at)),1)])):u("",!0),n("div",$e,[i.chatboxMode?u("",!0):(c(),g(P,{key:0,text:o.tm("actions.fullscreen")},{activator:l(({props:d})=>[r(b,F(d,{onClick:e[3]||(e[3]=x=>o.router.push(t.currCid?`/chatbox/${t.currCid}`:"/chatbox")),class:"fullscreen-icon"}),{default:l(()=>[C("mdi-fullscreen")]),_:2},1040)]),_:1},8,["text"])),i.chatboxMode?(c(),g(P,{key:1,text:o.t("core.common.language")},{activator:l(({props:d})=>[r(h,{variant:"chatbox"})]),_:1},8,["text"])):u("",!0),i.chatboxMode?(c(),g(P,{key:2,text:a.isDark?o.tm("modes.lightMode"):o.tm("modes.darkMode")},{activator:l(({props:d})=>[r(f,F(d,{icon:"",onClick:a.toggleTheme,class:"theme-toggle-icon",size:"small",rounded:"sm",style:{"margin-right":"8px"},variant:"text"}),{default:l(()=>[r(b,null,{default:l(()=>[C(m(a.isDark?"mdi-weather-night":"mdi-white-balance-sunny"),1)]),_:1})]),_:2},1040,["onClick"])]),_:1},8,["text"])):u("",!0),i.chatboxMode?(c(),g(P,{key:3,text:o.tm("actions.exitFullscreen")},{activator:l(({props:d})=>[r(b,F(d,{onClick:e[4]||(e[4]=x=>o.router.push(t.currCid?`/chat/${t.currCid}`:"/chat")),class:"fullscreen-icon"}),{default:l(()=>[C("mdi-fullscreen-exit")]),_:2},1040)]),_:1},8,["text"])):u("",!0)])]),t.currCid&&a.getCurrentConversation?(c(),g(X,{key:0,class:"conversation-divider"})):u("",!0),t.messages&&t.messages.length>0?(c(),g(w,{key:1,messages:t.messages,isDark:a.isDark,isStreaming:t.isStreaming||t.isConvRunning,onOpenImagePreview:a.openImagePreview,ref:"messageList"},null,8,["messages","isDark","isStreaming","onOpenImagePreview"])):(c(),v("div",et,[tt,n("div",st,[n("span",null,m(o.t("core.common.type")),1),it,n("span",null,m(o.tm("shortcuts.help"))+" 😊",1)]),n("div",ot,[n("span",null,m(o.t("core.common.longPress")),1),at,n("span",null,m(o.tm("shortcuts.voiceRecord"))+" 🎤",1)]),n("div",rt,[n("span",null,m(o.t("core.common.press")),1),lt,n("span",null,m(o.tm("shortcuts.pasteImage"))+" 🏞️",1)])])),n("div",nt,[n("div",dt,[ue(n("textarea",{id:"input-field","onUpdate:modelValue":e[5]||(e[5]=d=>t.prompt=d),onKeydown:e[6]||(e[6]=(...d)=>a.handleInputKeyDown&&a.handleInputKeyDown(...d)),disabled:t.isStreaming||t.isConvRunning,"onClick:clear":e[7]||(e[7]=(...d)=>a.clearMessage&&a.clearMessage(...d)),placeholder:"Ask AstrBot...",style:{width:"100%",resize:"none",outline:"none",border:"1px solid var(--v-theme-border)","border-radius":"12px",padding:"8px 16px","min-height":"40px","font-family":"inherit","font-size":"16px","background-color":"var(--v-theme-surface)"}},null,40,ct),[[me,t.prompt]]),n("div",ht,[n("div",ut,[r(y,{ref:"providerModelSelector"},null,512)]),n("div",mt,[n("input",{type:"file",ref:"imageInput",onChange:e[8]||(e[8]=(...d)=>a.handleFileSelect&&a.handleFileSelect(...d)),accept:"image/*",style:{display:"none"},multiple:""},null,544),t.isStreaming||t.isConvRunning?(c(),g(ge,{key:0,indeterminate:"",size:"16",class:"mr-1",width:"1.5"})):u("",!0),r(f,{onClick:a.triggerImageInput,icon:"mdi-plus",variant:"text",color:"deep-purple",class:"add-btn",size:"small"},null,8,["onClick"]),r(f,{onClick:e[9]||(e[9]=d=>t.isRecording?a.stopRecording():a.startRecording()),icon:t.isRecording?"mdi-stop-circle":"mdi-microphone",variant:"text",color:t.isRecording?"error":"deep-purple",class:"record-btn",size:"small"},null,8,["icon","color"]),r(f,{onClick:a.sendMessage,icon:"mdi-send",variant:"text",color:"deep-purple",disabled:!t.prompt&&t.stagedImagesName.length===0&&!t.stagedAudioUrl,class:"send-btn",size:"small"},null,8,["onClick","disabled"])])])]),t.stagedImagesUrl.length>0||t.stagedAudioUrl?(c(),v("div",gt,[(c(!0),v(T,null,U(t.stagedImagesUrl,(d,x)=>(c(),v("div",{key:x,class:"image-preview"},[n("img",{src:d,class:"preview-image"},null,8,pt),r(f,{onClick:M=>a.removeImage(x),class:"remove-attachment-btn",icon:"mdi-close",size:"small",color:"error",variant:"text"},null,8,["onClick"])]))),128)),t.stagedAudioUrl?(c(),v("div",vt,[r(pe,{color:"deep-purple-lighten-4",class:"audio-chip"},{default:l(()=>[r(b,{start:"",icon:"mdi-microphone",size:"small"}),C(" "+m(o.tm("voice.recording")),1)]),_:1}),r(f,{onClick:a.removeAudio,class:"remove-attachment-btn",icon:"mdi-close",size:"small",color:"error",variant:"text"},null,8,["onClick"])])):u("",!0)])):u("",!0)])])])]),_:1})]),_:1}),r(W,{modelValue:t.editTitleDialog,"onUpdate:modelValue":e[12]||(e[12]=d=>t.editTitleDialog=d),"max-width":"400"},{default:l(()=>[r(I,null,{default:l(()=>[r(H,{class:"dialog-title"},{default:l(()=>[C(m(o.tm("actions.editTitle")),1)]),_:1}),r(D,null,{default:l(()=>[r(Y,{modelValue:t.editingTitle,"onUpdate:modelValue":e[10]||(e[10]=d=>t.editingTitle=d),label:o.tm("conversation.newConversation"),variant:"outlined","hide-details":"",class:"mt-2",onKeyup:ve(a.saveTitle,["enter"]),autofocus:""},null,8,["modelValue","label","onKeyup"])]),_:1}),r(Z,null,{default:l(()=>[r($),r(f,{text:"",onClick:e[11]||(e[11]=d=>t.editTitleDialog=!1),color:"grey-darken-1"},{default:l(()=>[C(m(o.t("core.common.cancel")),1)]),_:1}),r(f,{text:"",onClick:a.saveTitle,color:"primary"},{default:l(()=>[C(m(o.t("core.common.save")),1)]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),r(W,{modelValue:t.imagePreviewDialog,"onUpdate:modelValue":e[14]||(e[14]=d=>t.imagePreviewDialog=d),"max-width":"90vw","max-height":"90vh"},{default:l(()=>[r(I,{class:"image-preview-card",elevation:"8"},{default:l(()=>[r(H,{class:"d-flex justify-space-between align-center pa-4"},{default:l(()=>[n("span",null,m(o.t("core.common.imagePreview")),1),r(f,{icon:"mdi-close",variant:"text",onClick:e[13]||(e[13]=d=>t.imagePreviewDialog=!1)})]),_:1}),r(D,{class:"text-center pa-4"},{default:l(()=>[n("img",{src:t.previewImageUrl,class:"preview-image-large"},null,8,ft)]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}const St=ee(ze,[["render",Ct]]);export{St as C};
