import{r as U,z as se,ae as ge,o as i,k as g,l as p,t as x,b as e,w as t,d as u,p as _,D as N,E as X,H as q,c as k,L as xe,f as I,aF as we,aG as K,m as Te,F as B,n as P,j as G,at as Ae,g as pe,i as te,V as re,e as H,W as Z,B as O,X as $,_ as z,aw as ve,ax as he,u as _e,C as M,T as Q,a7 as Y,x as Pe,aa as ae,ab as J,aC as oe,aD as ne,U as ie,h as W,aH as Oe,aB as Ie,aj as Ne,aE as Re,a5 as qe,a6 as me,aI as be,A as We,M as $e,O as Ge,ag as Je,N as He,J as Xe,K as Ye,I as Qe,P as Ze,a as Ke}from"./index-427e6df5.js";import{V as ue}from"./index-c4200cc5.js";import{L as Me,O as el,P as le,a as ke,K as ll}from"./KnowledgeBaseSelector-73bc8187.js";import{_ as de}from"./_plugin-vue_export-helper-c27b6911.js";import{W as sl}from"./WaitingForRestart-c0cfd70f.js";import"./common-74ca9dd8.js";const Ue=s=>(ve("data-v-edab4109"),s=s(),he(),s),tl={class:"d-flex align-center justify-space-between mb-2"},al={class:"flex-grow-1"},ol={key:0,style:{color:"rgb(var(--v-theme-primaryText))"}},nl={key:1,style:{color:"rgb(var(--v-theme-primaryText))"}},il={key:2,style:{color:"rgb(var(--v-theme-primaryText))"}},ul={key:1},rl={key:0,style:{"max-height":"300px","overflow-y":"auto"}},dl=Ue(()=>p("div",{class:"pl-8 pt-2"},[p("small",null,"*不显示系统插件和已经在插件页禁用的插件。")],-1)),cl={key:1,class:"text-center py-8"},fl=Ue(()=>p("p",{class:"text-grey mt-4"},"暂无可用的插件",-1)),ml={__name:"PluginSetSelector",props:{modelValue:{type:Array,default:()=>[]},buttonText:{type:String,default:"选择插件集合..."},maxDisplayItems:{type:Number,default:3}},emits:["update:modelValue"],setup(s,{emit:l}){const r=s,c=U(!1),o=U([]),m=U(!1),V=U("custom"),T=U([]),L=se(()=>r.modelValue&&r.modelValue.length===1&&r.modelValue[0]==="*");ge(()=>r.modelValue,v=>{!v||v.length===0?(V.value="none",T.value=[]):v.length===1&&v[0]==="*"?(V.value="all",T.value=[]):(V.value="custom",T.value=[...v])},{immediate:!0});async function d(){c.value=!0,await n()}async function n(){m.value=!0;try{const v=await z.get("/api/plugin/get");v.data.status==="ok"&&(o.value=(v.data.data||[]).filter(E=>E.activated&&!E.reserved).sort((E,C)=>E.name.localeCompare(C.name)))}catch(v){console.error("加载插件列表失败:",v),o.value=[]}finally{m.value=!1}}function w(){let v=[];switch(V.value){case"all":v=["*"];break;case"none":v=[];break;case"custom":v=[...T.value];break}l("update:modelValue",v),c.value=!1}function j(){const v=r.modelValue||[];v.length===0?(V.value="none",T.value=[]):v.length===1&&v[0]==="*"?(V.value="all",T.value=[]):(V.value="custom",T.value=[...v]),c.value=!1}return(v,E)=>(i(),g(B,null,[p("div",null,[p("div",tl,[p("div",al,[!s.modelValue||s.modelValue.length===0?(i(),g("span",ol," 未启用任何插件 ")):L.value?(i(),g("span",nl," 启用所有插件 (*) ")):(i(),g("span",il," 已选择 "+x(s.modelValue.length)+" 个插件 ",1))]),e(_,{size:"small",color:"primary",variant:"tonal",onClick:d},{default:t(()=>[u(x(s.buttonText),1)]),_:1})])]),e($,{modelValue:c.value,"onUpdate:modelValue":E[2]||(E[2]=C=>c.value=C),"max-width":"700px"},{default:t(()=>[e(N,null,{default:t(()=>[e(X,{class:"text-h3 py-4",style:{"font-weight":"normal"}},{default:t(()=>[u(" 选择插件集合 ")]),_:1}),e(q,{class:"pa-4"},{default:t(()=>[m.value?(i(),k(xe,{key:0,indeterminate:"",color:"primary"})):I("",!0),m.value?I("",!0):(i(),g("div",ul,[e(we,{modelValue:V.value,"onUpdate:modelValue":E[0]||(E[0]=C=>V.value=C),class:"mb-4","hide-details":""},{default:t(()=>[e(K,{value:"all",label:"启用所有插件",color:"primary"}),e(K,{value:"none",label:"不启用任何插件",color:"primary"}),e(K,{value:"custom",label:"自定义选择",color:"primary"})]),_:1},8,["modelValue"]),V.value==="custom"?(i(),g("div",rl,[o.value.length>0?(i(),k(Te,{key:0,density:"compact"},{default:t(()=>[(i(!0),g(B,null,P(o.value,C=>(i(),k(G,{key:C.name,rounded:"md",class:"ma-1"},{prepend:t(()=>[e(Ae,{modelValue:T.value,"onUpdate:modelValue":E[1]||(E[1]=R=>T.value=R),value:C.name,color:"primary","hide-details":""},null,8,["modelValue","value"])]),default:t(()=>[e(pe,null,{default:t(()=>[u(x(C.name),1)]),_:2},1024),e(te,null,{default:t(()=>[u(x(C.desc||"无描述")+" ",1),C.activated?I("",!0):(i(),k(re,{key:0,size:"x-small",color:"grey",class:"ml-1"},{default:t(()=>[u(" 未激活 ")]),_:1}))]),_:2},1024)]),_:2},1024))),128)),dl]),_:1})):(i(),g("div",cl,[e(H,{size:"64",color:"grey-lighten-1"},{default:t(()=>[u("mdi-puzzle-outline")]),_:1}),fl]))])):I("",!0)]))]),_:1}),e(Z,{class:"pa-4"},{default:t(()=>[e(O),e(_,{variant:"text",onClick:j},{default:t(()=>[u("取消")]),_:1}),e(_,{color:"primary",onClick:w},{default:t(()=>[u(" 确认选择 ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])],64))}},gl=de(ml,[["__scopeId","data-v-edab4109"]]);const ye=s=>(ve("data-v-a373ce1b"),s=s(),he(),s),pl=ye(()=>p("span",null,"自定义文转图 HTML 模板",-1)),vl={class:"d-flex align-center gap-2",style:{width:"60%"}},hl={class:"d-flex align-center pa-1",style:{border:"1px solid rgba(0,0,0,0.1)","border-radius":"8px"}},_l={class:"flex-grow-1",style:{"border-right":"1px solid rgba(0,0,0,0.1)"}},yl={class:"flex-grow-1 preview-container"},Vl=["srcdoc"],Cl={class:"text-caption text-grey"},bl=ye(()=>p("code",null," text | safe ",-1)),kl=ye(()=>p("code",null," version ",-1)),xl={__name:"T2ITemplateEditor",setup(s,{expose:l}){_e();const r=U(!1),c=U(!1),o=U(!1),m=U(!1),V=U(!1),T=U(!1),L=U([]),d=U("base"),n=U(null),w=U(""),j=U(""),v=U(!1),E=U(!1),C=U(!1),R=U(!1),F=U(null),D=se(()=>"vs-light"),a={automaticLayout:!0,fontSize:12,lineNumbers:"on",wordWrap:"on",minimap:{enabled:!1},scrollBeyondLastLine:!1},f={text:`这是一个示例文本，用于预览模板效果。

这里可以包含多行文本，支持换行和各种格式。`,version:"v4.0.0"},A=se(()=>{try{let y=j.value;return y=y.replace(/\{\{\s*text\s*\|\s*safe\s*\}\}/g,f.text),y=y.replace(/\{\{\s*version\s*\}\}/g,f.version),y}catch(y){return`<div style="color: red; padding: 20px;">模板渲染错误: ${y.message}</div>`}}),h=async()=>{c.value=!0;try{const[y,b]=await Promise.all([z.get("/api/t2i/templates"),z.get("/api/t2i/templates/active")]);y.data.status==="ok"?L.value=y.data.data:console.error("加载模板列表失败:",y.data.message),b.data.status==="ok"?d.value=b.data.data.active_template:console.error("加载活动模板失败:",b.data.message),L.value.length>0&&(n.value=d.value)}catch(y){console.error("加载初始数据失败:",y)}finally{c.value=!1}},Ve=async y=>{if(y){V.value=!0;try{const b=await z.get(`/api/t2i/templates/${y}`);b.data.status==="ok"?j.value=b.data.data.content:console.error(`加载模板 '${y}' 失败:`,b.data.message)}catch(b){console.error(`加载模板 '${y}' 失败:`,b)}finally{V.value=!1}}},Ce=async()=>{o.value=!0;try{if(v.value){if(!w.value)return;const y=await z.post("/api/t2i/templates/create",{name:w.value,content:j.value});await h(),n.value=y.data.data.name,v.value=!1}else{if(!n.value)return;await z.put(`/api/t2i/templates/${n.value}`,{content:j.value})}}catch(y){console.error("保存模板失败:",y)}finally{o.value=!1}},ee=async y=>{T.value=!0;try{await z.post("/api/t2i/templates/set_active",{name:y}),d.value=y}catch(b){console.error(`应用模板 '${y}' 失败:`,b)}finally{T.value=!1}},De=async()=>{if(!(!n.value||n.value==="base")){o.value=!0;try{const y=n.value;await z.delete(`/api/t2i/templates/${y}`),C.value=!1,d.value===y&&await ee("base"),await h(),n.value="base"}catch(y){console.error(`删除模板 '${n.value}' 失败:`,y)}finally{o.value=!1}}},Fe=async()=>{m.value=!0;try{await z.post("/api/t2i/templates/reset_default"),E.value=!1,n.value==="base"&&await Ve("base"),d.value!=="base"&&await ee("base")}catch(y){console.error("重置模板失败:",y)}finally{m.value=!1}},Se=()=>{E.value=!0},Ee=()=>{v.value=!0,n.value=null,w.value="",j.value=`<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>New Template</title>
</head>
<body>
  <!-- 从这里开始编辑 -->
  <article>{{ text | safe }}</article>
</body>
</html>
`},ze=()=>{n.value&&n.value!=="base"&&(C.value=!0)},Le=()=>{!v.value&&n.value&&(R.value=!0)},je=async()=>{v.value||(await Ce(),await ee(n.value),R.value=!1,ce())},Be=()=>{V.value=!0,Oe(()=>{F.value&&F.value.contentWindow.location.reload(),setTimeout(()=>V.value=!1,500)})},ce=()=>{r.value=!1};return ge(r,y=>{y?h():(n.value=null,j.value="",v.value=!1)}),ge(n,y=>{y&&(v.value=!1,Ve(y))}),l({openDialog:()=>{r.value=!0}}),(y,b)=>(i(),k($,{modelValue:r.value,"onUpdate:modelValue":b[9]||(b[9]=S=>r.value=S),"max-width":"1400px",persistent:"",scrollable:""},{activator:t(({props:S})=>[e(_,M(S,{variant:"outlined",color:"primary",size:"small",loading:c.value}),{default:t(()=>[u(" 自定义 T2I 模板 ")]),_:2},1040,["loading"])]),default:t(()=>[e(N,null,{default:t(()=>[e(X,{class:"d-flex align-center justify-space-between"},{default:t(()=>[pl,e(O),p("div",vl,[v.value?(i(),k(Q,{key:0,modelValue:w.value,"onUpdate:modelValue":b[0]||(b[0]=S=>w.value=S),label:"输入新模板名称",density:"compact","hide-details":"",variant:"outlined",class:"flex-grow-1",autofocus:"",rules:[S=>!!S||"名称不能为空"]},null,8,["modelValue","rules"])):(i(),k(Y,{key:1,modelValue:n.value,"onUpdate:modelValue":b[1]||(b[1]=S=>n.value=S),items:L.value,"item-title":"name","item-value":"name",label:"选择模板",density:"compact","hide-details":"",variant:"outlined",class:"flex-grow-1",loading:c.value},{item:t(({props:S,item:fe})=>[e(G,M(S,{title:fe.raw.name}),{append:t(()=>[fe.raw.name===d.value?(i(),k(re,{key:0,color:"success",variant:"tonal",size:"small",class:"ml-2"},{default:t(()=>[u(" 已应用 ")]),_:1})):(i(),k(_,{key:1,variant:"text",color:"primary",size:"small",class:"ml-2",onClick:Pe(Rs=>ee(fe.raw.name),["stop"]),loading:T.value},{default:t(()=>[u(" 应用 ")]),_:2},1032,["onClick","loading"]))]),_:2},1040,["title"])]),_:1},8,["modelValue","items","loading"])),e(_,{variant:"text",icon:"",onClick:ce},{default:t(()=>[e(H,null,{default:t(()=>[u("mdi-close")]),_:1})]),_:1})])]),_:1}),e(q,{class:"pa-0"},{default:t(()=>[e(ae,{"no-gutters":"",style:{height:"70vh"}},{default:t(()=>[e(J,{cols:"6",class:"d-flex flex-column"},{default:t(()=>[e(oe,{density:"compact",color:"surface-variant"},{default:t(()=>[e(ne,{class:"text-subtitle-2"},{default:t(()=>[u("模板编辑器")]),_:1}),e(O),p("div",hl,[e(_,{variant:"text",size:"small",onClick:Ee,color:"success"},{default:t(()=>[e(H,{left:""},{default:t(()=>[u("mdi-plus")]),_:1}),u(" 新建 ")]),_:1}),e(ie,{vertical:"",class:"mx-1"}),e(_,{variant:"text",size:"small",onClick:Se,loading:m.value,color:"warning"},{default:t(()=>[u(" 重置Base ")]),_:1},8,["loading"]),e(_,{variant:"text",size:"small",onClick:ze,color:"error",disabled:v.value||n.value==="base"||!n.value},{default:t(()=>[u(" 删除 ")]),_:1},8,["disabled"]),e(ie,{vertical:"",class:"mx-1"}),e(_,{variant:"text",size:"small",onClick:Ce,loading:o.value,color:"primary",disabled:v.value&&!w.value||!v.value&&!n.value},{default:t(()=>[u(" 保存 ")]),_:1},8,["loading","disabled"])])]),_:1}),p("div",_l,[e(W(ue),{value:j.value,"onUpdate:value":b[2]||(b[2]=S=>j.value=S),theme:D.value,language:"html",options:a,style:{height:"100%"}},null,8,["value","theme"])])]),_:1}),e(J,{cols:"6",class:"d-flex flex-column"},{default:t(()=>[e(oe,{density:"compact",color:"surface-variant"},{default:t(()=>[e(ne,{class:"text-subtitle-2"},{default:t(()=>[u("实时预览(可能有差异)")]),_:1}),e(O),e(_,{variant:"text",size:"small",onClick:Be,loading:V.value},{default:t(()=>[u(" 刷新预览 ")]),_:1},8,["loading"])]),_:1}),p("div",yl,[p("iframe",{ref_key:"previewFrame",ref:F,srcdoc:A.value,style:{width:"100%",height:"100%",border:"none",zoom:"0.6"}},null,8,Vl)])]),_:1})]),_:1})]),_:1}),e(Z,{class:"px-6 py-4"},{default:t(()=>[e(ae,{"no-gutters":"",class:"align-center"},{default:t(()=>[e(J,null,{default:t(()=>[p("div",Cl,[e(H,{size:"16",class:"mr-1"},{default:t(()=>[u("mdi-information")]),_:1}),u(" 支持 jinja2 语法。可用变量："),bl,u("（要渲染的文本）, "),kl,u("（AstrBot 版本） ")])]),_:1}),e(J,{cols:"auto"},{default:t(()=>[e(_,{variant:"text",onClick:ce},{default:t(()=>[u(" 取消 ")]),_:1}),e(_,{color:"primary",onClick:Le,loading:o.value,disabled:v.value||!n.value},{default:t(()=>[u(" 保存应用当前编辑模板 ")]),_:1},8,["loading","disabled"])]),_:1})]),_:1})]),_:1})]),_:1}),e($,{modelValue:E.value,"onUpdate:modelValue":b[4]||(b[4]=S=>E.value=S),"max-width":"400px"},{default:t(()=>[e(N,null,{default:t(()=>[e(X,null,{default:t(()=>[u("确认重置")]),_:1}),e(q,null,{default:t(()=>[u(" 确定要将 'base' 模板恢复为默认内容吗？当前编辑器中的任何未保存更改将丢失。此操作无法撤销。 ")]),_:1}),e(Z,null,{default:t(()=>[e(O),e(_,{text:"",onClick:b[3]||(b[3]=S=>E.value=!1)},{default:t(()=>[u("取消")]),_:1}),e(_,{color:"warning",onClick:Fe,loading:m.value},{default:t(()=>[u("确认重置")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),e($,{modelValue:C.value,"onUpdate:modelValue":b[6]||(b[6]=S=>C.value=S),"max-width":"400px"},{default:t(()=>[e(N,null,{default:t(()=>[e(X,null,{default:t(()=>[u("确认删除")]),_:1}),e(q,null,{default:t(()=>[u(" 确定要删除模板 '"+x(n.value)+"' 吗？此操作无法撤销。 ",1)]),_:1}),e(Z,null,{default:t(()=>[e(O),e(_,{text:"",onClick:b[5]||(b[5]=S=>C.value=!1)},{default:t(()=>[u("取消")]),_:1}),e(_,{color:"error",onClick:De,loading:o.value},{default:t(()=>[u("确认删除")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),e($,{modelValue:R.value,"onUpdate:modelValue":b[8]||(b[8]=S=>R.value=S),"max-width":"500px"},{default:t(()=>[e(N,null,{default:t(()=>[e(X,null,{default:t(()=>[u("确认操作")]),_:1}),e(q,null,{default:t(()=>[u(" 确定要保存对 '"+x(n.value)+"' 的修改，并将其设为新的活动模板吗？ ",1)]),_:1}),e(Z,null,{default:t(()=>[e(O),e(_,{text:"",onClick:b[7]||(b[7]=S=>R.value=!1)},{default:t(()=>[u("取消")]),_:1}),e(_,{color:"primary",onClick:je,loading:o.value},{default:t(()=>[u("确认")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue"]))}},wl=de(xl,[["__scopeId","data-v-a373ce1b"]]);const Tl=s=>(ve("data-v-0885d85c"),s=s(),he(),s),Il={key:0,class:"important-hint"},Rl={key:1,class:"object-config"},Ul={class:"property-key"},Dl={key:0,class:"important-hint"},Fl={key:0,class:"w-100"},Sl={key:1,class:"editor-container"},El={key:1},zl={key:2},Ll={key:3},jl={key:4},Bl={key:5},Al={key:6},Pl={key:7},Ol={key:8},Nl={key:9},ql={key:0,class:"selected-plugins-full-width"},Wl=Tl(()=>p("div",{class:"plugins-header"},[p("small",{class:"text-grey"},"已选择的插件：")],-1)),$l={class:"d-flex flex-wrap ga-2 mt-2"},Gl={__name:"AstrBotConfigV4",props:{metadata:{type:Object,required:!0},iterable:{type:Object,required:!0},metadataKey:{type:String,required:!0}},setup(s){const l=s,{t:r}=_e(),c=U(!1),o=U(""),m=U("json"),V=U("vs-light");let T=null;function L(C,R){const F=R.split(".");let D=C;for(const a of F)if(D&&typeof D=="object"&&a in D)D=D[a];else return;return D}function d(C,R,F){const D=R.split(".");let a=C;for(let f=0;f<D.length-1;f++){const A=D[f];(!a[A]||typeof a[A]!="object")&&(a[A]={}),a=a[A]}a[D[D.length-1]]=F}function n(C){return se({get(){return L(l.iterable,C)},set(R){d(l.iterable,C,R)}})}function w(C,R,F,D){o.value=C,m.value=D||"json",V.value=F||"vs-light",T=R,c.value=!0}function j(){c.value=!1}function v(C,R){if(!(C!=null&&C.condition))return!0;for(const[F,D]of Object.entries(C.condition))if(L(l.iterable,F)!==D)return!1;return!0}function E(C,R){const F=Object.entries(C);for(let D=R+1;D<F.length;D++){const[a,f]=F[D];if(v(f))return!0}return!1}return(C,R)=>(i(),g(B,null,[e(N,{style:{"margin-bottom":"16px","padding-bottom":"8px","background-color":"rgb(var(--v-theme-background))"},rounded:"md",variant:"outlined"},{default:t(()=>{var F,D;return[((F=s.metadata[s.metadataKey])==null?void 0:F.type)==="object"?(i(),k(q,{key:0,class:"config-section"},{default:t(()=>[e(pe,{class:"config-title"},{default:t(()=>{var a;return[u(x((a=s.metadata[s.metadataKey])==null?void 0:a.description),1)]}),_:1}),e(te,{class:"config-hint"},{default:t(()=>{var a,f,A;return[(a=s.metadata[s.metadataKey])!=null&&a.obvious_hint&&((f=s.metadata[s.metadataKey])!=null&&f.hint)?(i(),g("span",Il,"‼️")):I("",!0),u(" "+x((A=s.metadata[s.metadataKey])==null?void 0:A.hint),1)]}),_:1})]),_:1})):I("",!0),((D=s.metadata[s.metadataKey])==null?void 0:D.type)==="object"?(i(),g("div",Rl,[(i(!0),g(B,null,P(s.metadata[s.metadataKey].items,(a,f,A)=>(i(),g("div",{key:f,class:"config-item"},[v(a,f)?(i(),g(B,{key:0},[a!=null&&a.invisible?I("",!0):(i(),k(ae,{key:0,class:"config-row"},{default:t(()=>[e(J,{cols:"12",sm:"6",class:"property-info"},{default:t(()=>[e(G,{density:"compact"},{default:t(()=>[e(pe,{class:"property-name"},{default:t(()=>[u(x((a==null?void 0:a.description)||f)+" ",1),p("span",Ul,"("+x(f)+")",1)]),_:2},1024),e(te,{class:"property-hint"},{default:t(()=>[a!=null&&a.obvious_hint&&(a!=null&&a.hint)?(i(),g("span",Dl,"‼️")):I("",!0),u(" "+x(a==null?void 0:a.hint),1)]),_:2},1024)]),_:2},1024)]),_:2},1024),e(J,{cols:"12",sm:"6",class:"config-input"},{default:t(()=>[a!=null&&a._special?(a==null?void 0:a._special)==="select_provider"?(i(),g("div",El,[e(le,{modelValue:n(f).value,"onUpdate:modelValue":h=>n(f).value=h,"provider-type":"chat_completion"},null,8,["modelValue","onUpdate:modelValue"])])):(a==null?void 0:a._special)==="select_provider_stt"?(i(),g("div",zl,[e(le,{modelValue:n(f).value,"onUpdate:modelValue":h=>n(f).value=h,"provider-type":"speech_to_text"},null,8,["modelValue","onUpdate:modelValue"])])):(a==null?void 0:a._special)==="select_provider_tts"?(i(),g("div",Ll,[e(le,{modelValue:n(f).value,"onUpdate:modelValue":h=>n(f).value=h,"provider-type":"text_to_speech"},null,8,["modelValue","onUpdate:modelValue"])])):(a==null?void 0:a._special)==="provider_pool"?(i(),g("div",jl,[e(le,{modelValue:n(f).value,"onUpdate:modelValue":h=>n(f).value=h,"provider-type":"chat_completion","button-text":"选择提供商池..."},null,8,["modelValue","onUpdate:modelValue"])])):(a==null?void 0:a._special)==="select_persona"?(i(),g("div",Bl,[e(ke,{modelValue:n(f).value,"onUpdate:modelValue":h=>n(f).value=h},null,8,["modelValue","onUpdate:modelValue"])])):(a==null?void 0:a._special)==="persona_pool"?(i(),g("div",Al,[e(ke,{modelValue:n(f).value,"onUpdate:modelValue":h=>n(f).value=h,"button-text":"选择人格池..."},null,8,["modelValue","onUpdate:modelValue"])])):(a==null?void 0:a._special)==="select_knowledgebase"?(i(),g("div",Pl,[e(ll,{modelValue:n(f).value,"onUpdate:modelValue":h=>n(f).value=h},null,8,["modelValue","onUpdate:modelValue"])])):(a==null?void 0:a._special)==="select_plugin_set"?(i(),g("div",Ol,[e(gl,{modelValue:n(f).value,"onUpdate:modelValue":h=>n(f).value=h},null,8,["modelValue","onUpdate:modelValue"])])):(a==null?void 0:a._special)==="t2i_template"?(i(),g("div",Nl,[e(wl)])):I("",!0):(i(),g("div",Fl,[a!=null&&a.options?(i(),k(Y,{key:0,modelValue:n(f).value,"onUpdate:modelValue":h=>n(f).value=h,items:a==null?void 0:a.options,disabled:a==null?void 0:a.readonly,density:"compact",variant:"outlined",class:"config-field","hide-details":""},null,8,["modelValue","onUpdate:modelValue","items","disabled"])):a!=null&&a.editor_mode?(i(),g("div",Sl,[e(W(ue),{theme:(a==null?void 0:a.editor_theme)||"vs-light",language:(a==null?void 0:a.editor_language)||"json",style:{"min-height":"100px","flex-grow":"1",border:"1px solid rgba(0, 0, 0, 0.1)"},value:n(f).value,"onUpdate:value":h=>n(f).value=h},null,8,["theme","language","value","onUpdate:value"]),e(_,{icon:"",size:"small",variant:"text",color:"primary",class:"editor-fullscreen-btn",onClick:h=>w(f,s.iterable,a==null?void 0:a.editor_theme,a==null?void 0:a.editor_language),title:W(r)("core.common.editor.fullscreen")},{default:t(()=>[e(H,null,{default:t(()=>[u("mdi-fullscreen")]),_:1})]),_:2},1032,["onClick","title"])])):(a==null?void 0:a.type)==="string"?(i(),k(Q,{key:2,modelValue:n(f).value,"onUpdate:modelValue":h=>n(f).value=h,density:"compact",variant:"outlined",class:"config-field","hide-details":""},null,8,["modelValue","onUpdate:modelValue"])):(a==null?void 0:a.type)==="int"||(a==null?void 0:a.type)==="float"?(i(),k(Q,{key:3,modelValue:n(f).value,"onUpdate:modelValue":h=>n(f).value=h,density:"compact",variant:"outlined",class:"config-field",type:"number","hide-details":""},null,8,["modelValue","onUpdate:modelValue"])):(a==null?void 0:a.type)==="text"?(i(),k(Ie,{key:4,modelValue:n(f).value,"onUpdate:modelValue":h=>n(f).value=h,variant:"outlined",rows:"3",class:"config-field","hide-details":""},null,8,["modelValue","onUpdate:modelValue"])):(a==null?void 0:a.type)==="bool"?(i(),k(Ne,{key:5,modelValue:n(f).value,"onUpdate:modelValue":h=>n(f).value=h,color:"primary",inset:"",density:"compact","hide-details":"",style:{display:"flex","justify-content":"end"}},null,8,["modelValue","onUpdate:modelValue"])):(a==null?void 0:a.type)==="list"?(i(),k(Me,{key:6,modelValue:n(f).value,"onUpdate:modelValue":h=>n(f).value=h,"button-text":"修改",class:"config-field"},null,8,["modelValue","onUpdate:modelValue"])):(a==null?void 0:a.type)==="dict"?(i(),k(el,{key:7,modelValue:n(f).value,"onUpdate:modelValue":h=>n(f).value=h,class:"config-field"},null,8,["modelValue","onUpdate:modelValue"])):(i(),k(Q,{key:8,modelValue:n(f).value,"onUpdate:modelValue":h=>n(f).value=h,density:"compact",variant:"outlined",class:"config-field","hide-details":""},null,8,["modelValue","onUpdate:modelValue"]))]))]),_:2},1024)]),_:2},1024)),!(a!=null&&a.invisible)&&(a==null?void 0:a._special)==="select_plugin_set"?(i(),k(ae,{key:1,class:"plugin-set-display-row"},{default:t(()=>[e(J,{cols:"12",class:"plugin-set-display"},{default:t(()=>[n(f).value&&n(f).value.length>0?(i(),g("div",ql,[Wl,p("div",$l,[(i(!0),g(B,null,P(n(f).value||[],h=>(i(),k(re,{key:h,size:"small",label:"",color:"primary",variant:"outlined"},{default:t(()=>[u(x(h==="*"?"所有插件":h),1)]),_:2},1024))),128))])])):I("",!0)]),_:2},1024)]),_:2},1024)):I("",!0)],64)):I("",!0),v(a,f)&&E(s.metadata[s.metadataKey].items,A)?(i(),k(ie,{key:1,class:"config-divider"})):I("",!0)]))),128))])):I("",!0)]}),_:1}),e($,{modelValue:c.value,"onUpdate:modelValue":R[2]||(R[2]=F=>c.value=F),fullscreen:"",transition:"dialog-bottom-transition",scrollable:""},{default:t(()=>[e(N,null,{default:t(()=>[e(oe,{color:"primary",dark:""},{default:t(()=>[e(_,{icon:"",onClick:R[0]||(R[0]=F=>c.value=!1)},{default:t(()=>[e(H,null,{default:t(()=>[u("mdi-close")]),_:1})]),_:1}),e(ne,null,{default:t(()=>[u(x(W(r)("core.common.editor.editingTitle"))+" - "+x(o.value),1)]),_:1}),e(O),e(Re,null,{default:t(()=>[e(_,{variant:"text",onClick:j},{default:t(()=>[u(x(W(r)("core.common.save")),1)]),_:1})]),_:1})]),_:1}),e(q,{class:"pa-0"},{default:t(()=>[e(W(ue),{theme:V.value,language:m.value,style:{height:"calc(100vh - 64px)"},value:W(T)[o.value],"onUpdate:value":R[1]||(R[1]=F=>W(T)[o.value]=F)},null,8,["theme","language","value"])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64))}},Jl=de(Gl,[["__scopeId","data-v-0885d85c"]]);const Hl={name:"ConfigPage",components:{AstrBotConfigV4:Jl,VueMonacoEditor:ue,WaitingForRestart:sl},setup(){const{t:s}=_e(),{tm:l}=qe("features/config");return{t:s,tm:l}},computed:{messages(){return{loadError:this.tm("messages.loadError"),saveSuccess:this.tm("messages.saveSuccess"),saveError:this.tm("messages.saveError"),configApplied:this.tm("messages.configApplied"),configApplyError:this.tm("messages.configApplyError")}},configInfoNameList(){return this.configInfoList.map(s=>s.name)},selectedConfigInfo(){return this.configInfoList.find(s=>s.id===this.selectedConfigID)||{}},configSelectItems(){const s=[...this.configInfoList];return s.push({id:"_%manage%_",name:"管理配置文件...",umop:[]}),s}},watch:{config_data_str:function(s){this.config_data_has_changed=!0},customRuleInputMode:function(s){s==="builder"?this.syncCustomRulesFromManual():s==="manual"&&this.syncManualRulesText()}},data(){return{codeEditorDialog:!1,configManageDialog:!1,showConfigForm:!1,isEditingConfig:!1,config_data_has_changed:!1,config_data_str:"",config_data:{config:{}},fetched:!1,metadata:{},save_message_snack:!1,save_message:"",save_message_success:"",tab:0,configType:"normal",isSystemConfig:!1,appliedToRadioValue:"0",selectedConfigID:null,configInfoList:[],platformList:[],configFormData:{name:"",umop:[]},editingConfigId:null,conflictMessage:"",customRuleInputMode:"builder",customRules:[{platform:"*",messageType:"*",sessionId:"*"}],manualRulesText:"",messageTypeOptions:[{label:"所有消息类型",value:"*"},{label:"群组消息",value:"GroupMessage"},{label:"私聊消息",value:"FriendMessage"}]}},mounted(){this.getConfigInfoList("default"),this.configType=this.isSystemConfig?"system":"normal"},methods:{getConfigInfoList(s){z.get("/api/config/abconfs").then(l=>{if(this.configInfoList=l.data.data.info_list,s){for(let r=0;r<this.configInfoList.length;r++)if(this.configInfoList[r].id===s){this.selectedConfigID=this.configInfoList[r].id,this.getConfig(s);break}}}).catch(l=>{this.save_message=this.messages.loadError,this.save_message_snack=!0,this.save_message_success="error"})},getPlatformList(){z.get("/api/config/platform/list").then(s=>{this.platformList=s.data.data.platforms}).catch(s=>{console.error(this.t("status.dataError"),s)})},getConfig(s){this.fetched=!1;const l={};this.isSystemConfig?l.system_config="1":l.id=s||this.selectedConfigID,z.get("/api/config/abconf",{params:l}).then(r=>{this.config_data=r.data.data.config,this.fetched=!0,this.metadata=r.data.data.metadata}).catch(r=>{this.save_message=this.messages.loadError,this.save_message_snack=!0,this.save_message_success="error"})},updateConfig(){if(!this.fetched)return;const s={config:JSON.parse(JSON.stringify(this.config_data))};this.isSystemConfig?s.conf_id="default":s.conf_id=this.selectedConfigID,z.post("/api/config/astrbot/update",s).then(l=>{l.data.status==="ok"?(this.save_message=l.data.message||this.messages.saveSuccess,this.save_message_snack=!0,this.save_message_success="success",this.isSystemConfig&&z.post("/api/stat/restart-core").then(()=>{this.$refs.wfr.check()})):(this.save_message=l.data.message||this.messages.saveError,this.save_message_snack=!0,this.save_message_success="error")}).catch(l=>{this.save_message=this.messages.saveError,this.save_message_snack=!0,this.save_message_success="error"})},configToString(){this.config_data_str=JSON.stringify(this.config_data,null,2),this.config_data_has_changed=!1},applyStrConfig(){try{this.config_data=JSON.parse(this.config_data_str),this.config_data_has_changed=!1,this.save_message_success="success",this.save_message=this.messages.configApplied,this.save_message_snack=!0}catch{this.save_message_success="error",this.save_message=this.messages.configApplyError,this.save_message_snack=!0}},createNewConfig(){let s=[];this.appliedToRadioValue==="0"?s=this.configFormData.umop.map(l=>l+"::"):this.appliedToRadioValue==="1"&&(s=[...this.configFormData.umop]),z.post("/api/config/abconf/new",{umo_parts:s,name:this.configFormData.name}).then(l=>{l.data.status==="ok"?(this.save_message=l.data.message,this.save_message_snack=!0,this.save_message_success="success",this.getConfigInfoList(l.data.data.conf_id),this.cancelConfigForm()):(this.save_message=l.data.message,this.save_message_snack=!0,this.save_message_success="error")}).catch(l=>{console.error(l),this.save_message="新配置文件创建失败",this.save_message_snack=!0,this.save_message_success="error"})},checkPlatformConflict(s){const l=[];for(const r of this.configInfoList)r.name!=="default"&&r.umop&&r.umop.length>0&&this.hasUmoConflict(s,r.umop)&&l.push(r);return l},hasUmoConflict(s,l){for(const r of s)for(const c of l)if(this.isUmoMatch(r,c)||this.isUmoMatch(c,r))return!0;return!1},isUmoMatch(s,l){const r=this.normalizeUmoRule(s),c=this.normalizeUmoRule(l),o=r.split(":"),m=c.split(":");return o.length!==3||m.length!==3?!1:o.every((V,T)=>{const L=m[T];return V===""||V==="*"||V===L})},normalizeUmoRule(s){if(typeof s!="string")return"*:*:*";const l=s.split(":");return l.length===2&&l[1]===""?`${l[0]||"*"}:*:*`:l.length===3?l.map(r=>r===""?"*":r).join(":"):l.length===1?`${l[0]||"*"}:*:*`:"*:*:*"},getDetailedConflictInfo(s){const l=[],r=[...this.configInfoList].filter(c=>c.name!=="default").sort((c,o)=>c.id.localeCompare(o.id));for(const c of r){if(!c.umop||c.umop.length===0)continue;const o=[];for(const m of s)for(const V of c.umop)(this.isUmoMatch(m,V)||this.isUmoMatch(V,m))&&o.push({newRule:m,existingRule:V,matchType:this.getMatchType(m,V)});o.length>0&&l.push({config:c,conflicts:o})}return l},getMatchType(s,l){this.normalizeUmoRule(s),this.normalizeUmoRule(l);const r=this.isUmoMatch(s,l),c=this.isUmoMatch(l,s);return r&&c?"exact":r?"new_covers_existing":c?"existing_covers_new":"overlap"},formatConflictMessage(s){if(s.length===0)return"";let l="⚠️ <strong>规则冲突警告：</strong><br><br>";const r=[...s].sort((c,o)=>c.config.id.localeCompare(o.config.id));return r.forEach((c,o)=>{const m=c.config.name||c.config.id;l+=`<strong>${o+1}. 与配置文件 "${m}" 冲突：</strong><br>`,c.conflicts.forEach(V=>{const T=this.formatRuleForDisplay(V.newRule),L=this.formatRuleForDisplay(V.existingRule);switch(V.matchType){case"exact":l+=`规则完全相同: <code>${T}</code><br>`,l+=`<span style="color: orange;">"${m}" 将覆盖当前配置</span><br>`;break;case"new_covers_existing":l+=`当前规则 <code>${T}</code> 包含现有规则 <code>${L}</code><br>`,l+=`<span style="color: red;">"${m}" 的规则将优先匹配</span><br>`;break;case"existing_covers_new":l+=`现有规则 <code>${L}</code> 包含当前规则 <code>${T}</code><br>`,l+=`<span style="color: red;">"${m}" 的规则将优先匹配</span><br>`;break;case"overlap":l+=`规则重叠: <code>${T}</code> ↔ <code>${L}</code><br>`,l+=`<span style="color: orange;">"${m}" 在匹配范围内优先</span><br>`;break}}),o<r.length-1&&(l+="<br>")}),l+="<br><small><strong>💡 说明：</strong> 您仍可创建此配置文件。AstrBot 按配置文件创建顺序匹配规则，先创建的配置文件优先级更高。当多个配置文件的规则匹配同一个消息会话来源时，优先级最高的配置文件会生效（default 配置文件除外）。</small>",l},formatRuleForDisplay(s){const l=this.normalizeUmoRule(s).split(":"),r=l[0]==="*"||l[0]===""?"任意平台":l[0],c=l[1]==="*"||l[1]===""?"任意消息":this.getMessageTypeLabel(l[1]),o=l[2]==="*"||l[2]===""?"任意会话":l[2];return`${r}:${c}:${o}`},getMessageTypeLabel(s){return{GroupMessage:"群组消息",FriendMessage:"私聊消息"}[s]||s},onConfigSelect(s){s==="_%manage%_"?(this.configManageDialog=!0,this.getPlatformList(),this.$nextTick(()=>{this.selectedConfigID=this.selectedConfigInfo.id||"default"})):this.getConfig(s)},startCreateConfig(){this.showConfigForm=!0,this.isEditingConfig=!1,this.configFormData={name:"",umop:[]},this.editingConfigId=null,this.conflictMessage="",this.resetCustomRules()},startEditConfig(s){this.appliedToRadioValue="1",this.showConfigForm=!0,this.isEditingConfig=!0,this.editingConfigId=s.id,this.parseExistingCustomRules(s.umop||[]),this.configFormData={name:s.name||"",umop:[...s.umop||[]]},this.conflictMessage=""},cancelConfigForm(){this.showConfigForm=!1,this.isEditingConfig=!1,this.editingConfigId=null,this.configFormData={name:"",umop:[]},this.conflictMessage="",this.resetCustomRules()},saveConfigForm(){if(!this.configFormData.name||!this.configFormData.umop.length){this.save_message="请填写配置名称和选择应用平台",this.save_message_snack=!0,this.save_message_success="error";return}this.isEditingConfig?this.updateConfigInfo():this.createNewConfig()},addCustomRule(){this.customRules.push({platform:"*",messageType:"*",sessionId:"*"}),this.updateCustomRulesFromBuilder()},removeCustomRule(s){this.customRules.length>1&&(this.customRules.splice(s,1),this.updateCustomRulesFromBuilder())},updateCustomRule(s){this.updateCustomRulesFromBuilder()},updateCustomRulesFromBuilder(){const s=this.customRules.map(l=>{const r=l.platform==="*"?"":l.platform,c=l.messageType==="*"?"":l.messageType,o=l.sessionId==="*"?"":l.sessionId||"";return`${r}:${c}:${o}`});this.configFormData.umop=s,this.syncManualRulesText(),this.checkPlatformConflictOnForm()},updateManualRules(){const s=this.manualRulesText.split(`
`).map(l=>l.trim()).filter(l=>l);this.configFormData.umop=s,this.syncCustomRulesFromManual(),this.checkPlatformConflictOnForm()},syncManualRulesText(){this.manualRulesText=this.configFormData.umop.join(`
`)},syncCustomRulesFromManual(){this.customRules=this.configFormData.umop.map(s=>{const l=s.split(":");return{platform:l[0]||"*",messageType:l[1]||"*",sessionId:l[2]||"*"}})},resetCustomRules(){this.customRuleInputMode="builder",this.customRules=[{platform:"*",messageType:"*",sessionId:"*"}],this.manualRulesText="",this.appliedToRadioValue==="1"&&this.updateCustomRulesFromBuilder()},parseExistingCustomRules(s){if(!s||s.length===0){this.resetCustomRules();return}this.customRules=s.map(l=>{const r=l.split(":");return{platform:r[0]||"*",messageType:r[1]||"*",sessionId:r[2]||"*"}}),this.syncManualRulesText()},confirmDeleteConfig(s){confirm(`确定要删除配置文件 "${s.name}" 吗？此操作不可恢复。`)&&this.deleteConfig(s.id)},deleteConfig(s){z.post("/api/config/abconf/delete",{id:s}).then(l=>{l.data.status==="ok"?(this.save_message=l.data.message,this.save_message_snack=!0,this.save_message_success="success",this.getConfigInfoList("default")):(this.save_message=l.data.message,this.save_message_snack=!0,this.save_message_success="error")}).catch(l=>{console.error(l),this.save_message="删除配置文件失败",this.save_message_snack=!0,this.save_message_success="error"})},checkPlatformConflictOnForm(){if(!this.configFormData.umop||this.configFormData.umop.length===0){this.conflictMessage="";return}let s=[];this.appliedToRadioValue==="0"?s=this.configFormData.umop.map(r=>`${r}:*:*`):s=[...this.configFormData.umop];let l=this.getDetailedConflictInfo(s);this.isEditingConfig&&this.editingConfigId&&(l=l.filter(r=>r.config.id!==this.editingConfigId)),l.length>0?this.conflictMessage=this.formatConflictMessage(l):this.conflictMessage=""},updateConfigInfo(){let s=[];this.appliedToRadioValue==="0"?s=this.configFormData.umop.map(l=>l+"::"):this.appliedToRadioValue==="1"&&(s=[...this.configFormData.umop]),z.post("/api/config/abconf/update",{id:this.editingConfigId,name:this.configFormData.name,umo_parts:s}).then(l=>{l.data.status==="ok"?(this.save_message=l.data.message,this.save_message_snack=!0,this.save_message_success="success",this.getConfigInfoList(this.editingConfigId),this.cancelConfigForm()):(this.save_message=l.data.message,this.save_message_snack=!0,this.save_message_success="error")}).catch(l=>{console.error(l),this.save_message="更新配置文件失败",this.save_message_snack=!0,this.save_message_success="error"})},formatUmop(s){if(!s)return;let l="";for(let r=0;r<s.length;r++){const c=s[r].split(":");if(c.length===3){const o=c[0]||"*",m=c[1]||"*",V=c[2]||"*";if(o==="*"&&m==="*"&&V==="*")return"所有平台";l+=`${o}:${m}:${V},`}else{let o=s[r].split(":")[0];if(o==="")return"所有平台";l+=o+","}}return l=l.slice(0,-1),l},onConfigTypeToggle(){this.isSystemConfig=this.configType==="system",this.tab=0,this.fetched=!1,this.isSystemConfig?this.getConfig():this.selectedConfigID?this.getConfig(this.selectedConfigID):this.getConfigInfoList("default")},onSystemConfigToggle(){this.configType=this.isSystemConfig?"system":"normal",this.tab=0,this.fetched=!1,this.isSystemConfig?this.getConfig():this.selectedConfigID?this.getConfig(this.selectedConfigID):this.getConfigInfoList("default")}}},Xl={style:{display:"flex","flex-direction":"column","align-items":"center"}},Yl={key:0,class:"mt-4 config-panel",style:{display:"flex","flex-direction":"column","align-items":"start"}},Ql={class:"d-flex flex-row pr-4",style:{"margin-bottom":"16px","align-items":"center",gap:"12px","justify-content":"space-between",width:"100%"}},Zl={class:"d-flex flex-row align-center",style:{gap:"12px"}},Kl={style:{color:"inherit"},href:"https://blog.astrbot.app/posts/what-is-changed-in-4.0.0/#%E5%A4%9A%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6",target:"_blank"},Ml={key:1,style:{width:"100%"}},es={style:{"margin-left":"16px","padding-bottom":"16px"}},ls={href:"https://astrbot.app/",target:"_blank"},ss={href:"https://qm.qq.com/cgi-bin/qm/qr?k=EYGsuUTfe00_iOu9JTXS7_TEpMkXOvwv&jump_from=webapi&authKey=uUEMKCROfsseS+8IzqPjzV3y1tzy4AkykwTib2jNkOFdzezF9s9XknqnIaf3CDft",target:"_blank"},ts={style:{"margin-left":"16px"}},as=p("span",{class:"text-h4"},"配置文件管理",-1),os=p("small",null,"AstrBot 支持针对不同消息平台实例分别设置配置文件。默认会使用 `default` 配置。",-1),ns={class:"mt-6 mb-4"},is={class:"d-flex align-center",style:{gap:"8px"}},us={key:1},rs={class:"mb-4"},ds={class:"mb-4"},cs={key:0,class:"text-warning"},fs=["innerHTML"],ms=p("h4",null,"名称",-1),gs=p("h4",null,"应用于",-1),ps=p("span",null,"指定消息平台...",-1),vs={key:1,class:"ma-2"},hs=p("small",{class:"text-medium-emphasis mb-4 d-block"},"UMO 格式: [platform_id]:[message_type]:[session_id]。通配符 * 或留空表示全部。使用 /sid 查看某个聊天的 UMO。",-1),_s={key:0,class:"mb-4"},ys={key:1,class:"mb-4"},Vs={class:"mb-2"},Cs={class:"text-medium-emphasis"},bs=p("strong",null,"预览:",-1),ks={key:0,class:"text-error"},xs={key:1,class:"mt-1"},ws=p("small",null,"这些规则对应的会话将使用此配置文件。",-1),Ts={class:"d-flex justify-end mt-4",style:{gap:"8px"}};function Is(s,l,r,c,o,m){const V=me("AstrBotConfigV4"),T=me("VueMonacoEditor"),L=me("WaitingForRestart");return i(),g(B,null,[p("div",Xl,[o.selectedConfigID||o.isSystemConfig?(i(),g("div",Yl,[p("div",Ql,[p("div",Zl,[o.isSystemConfig?I("",!0):(i(),k(Y,{key:0,style:{"min-width":"130px"},modelValue:o.selectedConfigID,"onUpdate:modelValue":[l[0]||(l[0]=d=>o.selectedConfigID=d),m.onConfigSelect],items:m.configSelectItems,"item-title":"name","item-value":"id",label:"选择配置文件","hide-details":"",density:"compact",rounded:"md",variant:"outlined"},{item:t(({props:d,item:n})=>[e(G,M(d,{subtitle:n.raw.id==="_%manage%_"?"管理所有配置文件":m.formatUmop(n.raw.umop),class:n.raw.id==="_%manage%_"?"text-primary":""}),null,16,["subtitle","class"])]),_:1},8,["modelValue","items","onUpdate:modelValue"])),p("a",Kl,[e(_,{icon:"mdi-help-circle",size:"small",variant:"plain"})])]),e(be,{modelValue:o.configType,"onUpdate:modelValue":[l[1]||(l[1]=d=>o.configType=d),m.onConfigTypeToggle],mandatory:"",color:"primary",variant:"outlined",density:"comfortable",rounded:"md"},{default:t(()=>[e(_,{value:"normal","prepend-icon":"mdi-cog",size:"large"},{default:t(()=>[u(" 普通 ")]),_:1}),e(_,{value:"system","prepend-icon":"mdi-cog-outline",size:"large"},{default:t(()=>[u(" 系统 ")]),_:1})]),_:1},8,["modelValue","onUpdate:modelValue"])]),o.fetched?I("",!0):(i(),k(xe,{key:0,indeterminate:"",color:"primary"})),(o.selectedConfigID||o.isSystemConfig)&&o.fetched?(i(),g("div",Ml,[p("div",{class:We(s.$vuetify.display.mobile?"":"d-flex")},[e($e,{modelValue:o.tab,"onUpdate:modelValue":l[2]||(l[2]=d=>o.tab=d),direction:s.$vuetify.display.mobile?"horizontal":"vertical","align-tabs":s.$vuetify.display.mobile?"left":"start",color:"deep-purple-accent-4",class:"config-tabs"},{default:t(()=>[(i(!0),g(B,null,P(o.metadata,(d,n,w)=>(i(),k(He,{key:w,value:w,style:{"font-weight":"1000","font-size":"15px"}},{default:t(()=>[u(x(o.metadata[n].name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue","direction","align-tabs"]),e(Ge,{modelValue:o.tab,"onUpdate:modelValue":l[3]||(l[3]=d=>o.tab=d),class:"config-tabs-window"},{default:t(()=>[(i(!0),g(B,null,P(o.metadata,(d,n,w)=>Xe((i(),k(Ze,{key:w},{default:t(()=>[e(Qe,{fluid:""},{default:t(()=>[(i(!0),g(B,null,P(o.metadata[n].metadata,(j,v,E)=>(i(),g("div",{key:v},[e(V,{metadata:{[v]:o.metadata[n].metadata[v]},iterable:o.config_data,metadataKey:v},null,8,["metadata","iterable","metadataKey"])]))),128))]),_:2},1024)]),_:2},1024)),[[Ye,w==o.tab]])),128)),p("div",es,[p("small",null,[u(x(c.tm("help.helpPrefix"))+" ",1),p("a",ls,x(c.tm("help.documentation")),1),u(" "+x(c.tm("help.helpMiddle"))+" ",1),p("a",ss,x(c.tm("help.support")),1),u(x(c.tm("help.helpSuffix")),1)])])]),_:1},8,["modelValue"])],2),e(_,{icon:"mdi-content-save",size:"x-large",style:{position:"fixed",right:"52px",bottom:"52px"},color:"darkprimary",onClick:m.updateConfig},null,8,["onClick"]),e(_,{icon:"mdi-code-json",size:"x-large",style:{position:"fixed",right:"52px",bottom:"124px"},color:"primary",onClick:l[4]||(l[4]=d=>{m.configToString(),o.codeEditorDialog=!0})})])):I("",!0)])):I("",!0)]),e($,{modelValue:o.codeEditorDialog,"onUpdate:modelValue":l[9]||(l[9]=d=>o.codeEditorDialog=d),fullscreen:"",transition:"dialog-bottom-transition",scrollable:""},{default:t(()=>[e(N,null,{default:t(()=>[e(oe,{color:"primary",dark:""},{default:t(()=>[e(_,{icon:"",onClick:l[5]||(l[5]=d=>o.codeEditorDialog=!1)},{default:t(()=>[e(H,null,{default:t(()=>[u("mdi-close")]),_:1})]),_:1}),e(ne,null,{default:t(()=>[u("编辑配置文件")]),_:1}),e(O),e(Re,{style:{display:"flex","align-items":"center"}},{default:t(()=>[e(_,{style:{"margin-left":"16px"},size:"small",onClick:l[6]||(l[6]=d=>m.configToString())},{default:t(()=>[u(x(c.tm("editor.revertCode")),1)]),_:1}),o.config_data_has_changed?(i(),k(_,{key:0,style:{"margin-left":"16px"},size:"small",onClick:l[7]||(l[7]=d=>m.applyStrConfig())},{default:t(()=>[u(x(c.tm("editor.applyConfig")),1)]),_:1})):I("",!0),p("small",ts,"💡 "+x(c.tm("editor.applyTip")),1)]),_:1})]),_:1}),e(q,{class:"pa-0"},{default:t(()=>[e(T,{language:"json",theme:"vs-dark",style:{height:"calc(100vh - 64px)"},value:o.config_data_str,"onUpdate:value":l[8]||(l[8]=d=>o.config_data_str=d)},null,8,["value"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),e($,{modelValue:o.configManageDialog,"onUpdate:modelValue":l[16]||(l[16]=d=>o.configManageDialog=d),"max-width":"800px"},{default:t(()=>[e(N,null,{default:t(()=>[e(X,{class:"d-flex align-center justify-space-between"},{default:t(()=>[as,e(_,{icon:"mdi-close",variant:"text",onClick:l[10]||(l[10]=d=>o.configManageDialog=!1)})]),_:1}),e(q,null,{default:t(()=>[os,p("div",ns,[e(_,{"prepend-icon":"mdi-plus",onClick:m.startCreateConfig,variant:"tonal",color:"primary"},{default:t(()=>[u(" 新建配置文件 ")]),_:1},8,["onClick"])]),e(Te,{lines:"two"},{default:t(()=>[(i(!0),g(B,null,P(o.configInfoList,d=>(i(),k(G,{key:d.id,title:d.name},Ke({default:t(()=>[e(te,null,{default:t(()=>[u("当前应用于: "+x(m.formatUmop(d.umop)),1)]),_:2},1024)]),_:2},[d.id!=="default"?{name:"append",fn:t(()=>[p("div",is,[e(_,{icon:"mdi-pencil",size:"small",variant:"text",color:"warning",onClick:n=>m.startEditConfig(d)},null,8,["onClick"]),e(_,{icon:"mdi-delete",size:"small",variant:"text",color:"error",onClick:n=>m.confirmDeleteConfig(d)},null,8,["onClick"])])]),key:"0"}:void 0]),1032,["title"]))),128))]),_:1}),o.showConfigForm?(i(),k(ie,{key:0,class:"my-6"})):I("",!0),o.showConfigForm?(i(),g("div",us,[p("h3",rs,x(o.isEditingConfig?"编辑配置文件":"新建配置文件"),1),p("div",ds,[o.conflictMessage?(i(),g("div",cs,[p("div",{innerHTML:o.conflictMessage,style:{"font-size":"0.875rem","line-height":"1.4"}},null,8,fs)])):I("",!0)]),ms,e(Q,{modelValue:o.configFormData.name,"onUpdate:modelValue":l[11]||(l[11]=d=>o.configFormData.name=d),label:"填写配置文件名称",variant:"outlined",class:"mt-4 mb-4","hide-details":""},null,8,["modelValue"]),gs,e(we,{class:"mt-2",modelValue:o.appliedToRadioValue,"onUpdate:modelValue":l[15]||(l[15]=d=>o.appliedToRadioValue=d),"hide-details":"true"},{default:t(()=>[e(K,{value:"0"},{label:t(()=>[ps]),_:1}),o.appliedToRadioValue==="0"?(i(),k(Y,{key:0,modelValue:o.configFormData.umop,"onUpdate:modelValue":[l[12]||(l[12]=d=>o.configFormData.umop=d),m.checkPlatformConflictOnForm],items:o.platformList,"item-title":"id","item-value":"id",label:"选择已配置的消息平台(可多选)",variant:"outlined","hide-details":"",multiple:"",class:"ma-2"},{item:t(({props:d,item:n})=>[e(G,M(d,{subtitle:n.raw.type}),null,16,["subtitle"])]),_:1},8,["modelValue","items","onUpdate:modelValue"])):I("",!0),e(K,{value:"1",label:"自定义规则(实验性)"}),o.appliedToRadioValue==="1"?(i(),g("div",vs,[hs,e(be,{modelValue:o.customRuleInputMode,"onUpdate:modelValue":l[13]||(l[13]=d=>o.customRuleInputMode=d),mandatory:"",color:"primary",variant:"outlined",density:"compact",rounded:"md",class:"mb-4"},{default:t(()=>[e(_,{value:"builder","prepend-icon":"mdi-tune",size:"x-small"},{default:t(()=>[u(" 可视化 ")]),_:1}),e(_,{value:"manual","prepend-icon":"mdi-code-tags",size:"x-small"},{default:t(()=>[u(" 手动编辑 ")]),_:1})]),_:1},8,["modelValue"]),o.customRuleInputMode==="builder"?(i(),g("div",_s,[(i(!0),g(B,null,P(o.customRules,(d,n)=>(i(),g("div",{key:n,class:"d-flex align-center mb-2",style:{gap:"8px"}},[e(Y,{modelValue:d.platform,"onUpdate:modelValue":[w=>d.platform=w,w=>m.updateCustomRule(n)],items:[{id:"*",type:"所有平台"},...o.platformList],"item-title":"id","item-value":"id",label:"平台",variant:"outlined",density:"compact",style:{"min-width":"120px"}},{item:t(({props:w,item:j})=>[e(G,M(w,{subtitle:j.raw.type}),null,16,["subtitle"])]),_:2},1032,["modelValue","onUpdate:modelValue","items"]),e(Y,{modelValue:d.messageType,"onUpdate:modelValue":[w=>d.messageType=w,w=>m.updateCustomRule(n)],items:o.messageTypeOptions,"item-title":"label","item-value":"value",label:"消息类型",variant:"outlined",density:"compact",style:{"min-width":"130px"}},null,8,["modelValue","onUpdate:modelValue","items"]),e(Q,{modelValue:d.sessionId,"onUpdate:modelValue":[w=>d.sessionId=w,w=>m.updateCustomRule(n)],label:"会话ID",variant:"outlined",density:"compact",placeholder:"* 或留空表示全部",style:{"min-width":"120px"}},null,8,["modelValue","onUpdate:modelValue"]),e(_,{icon:"mdi-delete",size:"small",variant:"text",color:"error",onClick:w=>m.removeCustomRule(n),disabled:o.customRules.length===1},null,8,["onClick","disabled"])]))),128)),e(_,{"prepend-icon":"mdi-plus",size:"small",variant:"tonal",color:"primary",onClick:m.addCustomRule},{default:t(()=>[u(" 添加规则 ")]),_:1},8,["onClick"])])):I("",!0),o.customRuleInputMode==="manual"?(i(),g("div",ys,[e(Ie,{modelValue:o.manualRulesText,"onUpdate:modelValue":[l[14]||(l[14]=d=>o.manualRulesText=d),m.updateManualRules],label:"手动输入规则(每行一个)",variant:"outlined",rows:"4",placeholder:`每行一个规则，例如：
platform1:GroupMessage:*
*:FriendMessage:session123
*:*:*`},null,8,["modelValue","onUpdate:modelValue"])])):I("",!0),p("div",Vs,[p("small",Cs,[bs,o.configFormData.umop.length?(i(),g("div",xs,[(i(!0),g(B,null,P(o.configFormData.umop,(d,n)=>(i(),k(re,{key:n,size:"x-small",rounded:"sm",class:"mr-1"},{default:t(()=>[u(x(d),1)]),_:2},1024))),128))])):(i(),g("span",ks,"未配置任何规则")),ws])])])):I("",!0)]),_:1},8,["modelValue"]),p("div",Ts,[e(_,{variant:"text",onClick:m.cancelConfigForm},{default:t(()=>[u("取消")]),_:1},8,["onClick"]),e(_,{color:"primary",onClick:m.saveConfigForm,disabled:!o.configFormData.name||!o.configFormData.umop.length},{default:t(()=>[u(x(o.isEditingConfig?"更新":"创建"),1)]),_:1},8,["onClick","disabled"])])])):I("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(Je,{timeout:3e3,elevation:"24",color:o.save_message_success,modelValue:o.save_message_snack,"onUpdate:modelValue":l[17]||(l[17]=d=>o.save_message_snack=d)},{default:t(()=>[u(x(o.save_message),1)]),_:1},8,["color","modelValue"]),e(L,{ref:"wfr"},null,512)],64)}const Ls=de(Hl,[["render",Is]]);export{Ls as default};
